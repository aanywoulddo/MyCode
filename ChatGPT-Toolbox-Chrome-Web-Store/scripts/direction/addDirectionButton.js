(()=>{"use strict";var e={5381:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,s)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.generateJWT=function(){return n(this,void 0,void 0,(function*(){try{return(0,o.fetchFromAPI)("https://api.infi-dev.com/ai-toolbox/auth/generate-jwt",!0)}catch(e){}}))},t.cancelDeletion=function(){return n(this,void 0,void 0,(function*(){try{(0,o.fetchFromAPI)("https://api.infi-dev.com/ai-toolbox/user/cancel-deletion",!0,{method:"PATCH",headers:{"Content-Type":"application/json"}})}catch(e){}}))},t.fetchJWKSFromServer=function(e){return n(this,void 0,void 0,(function*(){try{const t=yield fetch(`https://api.infi-dev.com/ai-toolbox/auth/jwks?jwksuri=${encodeURIComponent(e)}&cacheBuster=${(new Date).getTime()}`);if(!t.ok)throw new Error(`Failed to fetch JWKS: ${t.status} ${t.statusText}`);return yield t.json()}catch(e){throw e}}))};const o=r(5074)},571:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default='\n  <svg fill="currentColor" width="18px" height="18px" viewBox="0 0 1920 1920" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="9.6"><g id="infi-ltr-icon" stroke-width="0"></g><g id="infi-ltr-icon" stroke-linecap="round" stroke-linejoin="round"></g><g id="infi-ltr-icon"> <path d="M306.205 1607.01h1290.597l-193.598 193.603L1522.588 1920 1920 1522.577l-397.412-397.423-119.384 119.387 193.598 193.604H306.205v168.864Zm389.661-819.34h33.35v447.153h168.86V168.865h196.722v1065.958h168.86V168.865h171.393V0H695.866C478.712 0 302 176.632 302 393.792c0 217.245 176.712 393.877 393.866 393.877" fill-rule="evenodd"></path> </g></svg>\n'},6707:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default='\n  <svg fill="currentColor" width="18px" height="18px" viewBox="0 0 1920 1920" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="9.6"><g id="infi-rtl-icon" stroke-width="0"></g><g id="infi-rtl-icon" stroke-linecap="round" stroke-linejoin="round"></g><g id="infi-rtl-icon"> <path d="M822.456 787.786h33.337v447.22h168.8V168.89h196.652v1066.115h168.8V168.89h171.331V0h-738.92C605.379 0 428.73 176.659 428.73 393.85c0 217.277 176.65 393.936 393.726 393.936m949.528 650.39H523.268l193.65-193.592-119.416-119.38-397.518 397.398L597.502 1920l119.416-119.38-193.65-193.59h1248.716v-168.855Z" fill-rule="evenodd"></path> </g></svg>\n'},227:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.directionButtonHTML=void 0;const o=n(r(6707)),i=n(r(571));t.directionButtonHTML=({t:e,direction:t})=>`\n  <button class="infi-direction-button h-10 rounded-lg px-2 text-token-text-secondary focus-visible:outline-0 disabled:text-token-text-quaternary focus-visible:bg-token-main-surface-secondary enabled:hover:bg-token-main-surface-secondary" aria-label="${e("rtl"===t?"SWITCH_TO_LTR":"SWITCH_TO_RTL")}" data-tooltip="${e("rtl"===t?"SWITCH_TO_LTR":"SWITCH_TO_RTL")}">\n    ${"rtl"===t?i.default:o.default}  \n  </button>\n`},8617:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,s)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.addDirectionButton=function(){return n(this,void 0,void 0,(function*(){const e=window.location.origin+window.location.pathname;if("https://chatgpt.com/gpts"===e||"https://chatgpt.com/gpts/mine"===e)return;yield(0,s.insertDirectionButton)(),yield new Promise((e=>setTimeout((()=>{e(!0)}),100)));const t=document.querySelector(".infi-direction-button");if(!t)return;yield(0,i.addDirectionTooltip)();(0,l.manageEventListeners)("click",(e=>n(this,void 0,void 0,(function*(){e.preventDefault(),yield(0,a.handleDirectionClick)(e),yield(0,d.handlePlaceholderDirection)(),yield(0,o.handleMathDirection)()}))),t),(0,l.manageEventListeners)("keydown",(e=>n(this,void 0,void 0,(function*(){const t=e;"Enter"===t.key&&(t.preventDefault(),yield(0,a.handleDirectionClick)(e),yield(0,d.handlePlaceholderDirection)(),yield(0,o.handleMathDirection)())}))),t),yield(0,c.handleCanvasMouseOver)()}))};const o=r(9972),i=r(8318),a=r(7476),s=r(1867),c=r(9858),d=r(8685),l=r(7392)},8318:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,s)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.addDirectionTooltip=function(){return n(this,void 0,void 0,(function*(){const{direction:e}=yield(0,i.getStore)();document.querySelectorAll(".infi-direction-button").forEach((t=>{if(!t.querySelector(".infi-voice-download-tooltip")){const r=function(e){const t=document.createElement("div");return t.className="infi-voice-download-tooltip",t.textContent=(0,o.t)("rtl"===e?"SWITCH_TO_LTR":"SWITCH_TO_RTL"),t}(e),n=()=>{!function(e,t){document.querySelectorAll(".infi-voice-download-tooltip").forEach((e=>e.remove()));const r=e.getBoundingClientRect();t.style.left=`${r.left+r.width/2}px`,t.style.top=`${r.bottom+8}px`,document.body.appendChild(t)}(t,r)},i=()=>{const e=document.querySelector(".infi-voice-download-tooltip");null==e||e.remove()};(0,a.manageEventListeners)("mouseenter",n,t),(0,a.manageEventListeners)("mouseleave",i,t)}}))}))};const o=r(6907),i=r(2997),a=r(7392)},9858:function(e,t){var r=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,s)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.handleCanvasMouseOver=function(){return r(this,void 0,void 0,(function*(){const e=document.querySelector("div.h-full > section > main"),t=null==e?void 0:e.querySelector(".markdown.prose");t&&t.addEventListener("mousemove",(function(e){const t=e.target.closest("div#prosemirror-editor-container"),r=null==t?void 0:t.querySelector(".pointer-events-auto.absolute");if(!r)return;r.style.top="7px",r.style.left="4px",r.style.paddingLeft="0";r.querySelectorAll(".pointer-events-auto").forEach((e=>{e.style.zIndex="2",e.style.backgroundColor="white";const r=e.querySelector("button");null==r||r.addEventListener("mouseover",(()=>{const e=null==t?void 0:t.children;if(e&&e.length>1){const r=e[e.length-2],n=t.firstElementChild;if(n){const e=getComputedStyle(n),t=n.clientWidth-parseFloat(e.paddingLeft)-parseFloat(e.paddingRight);r.style.width=`${t}px`}}}))}));r.querySelectorAll("div.whitespace-pre-wrap").forEach((e=>{e.style.direction="rtl",e.style.textAlign="start"}))}))}))}},7476:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,s)}c((n=n.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.handleDirectionClick=function(e){return n(this,void 0,void 0,(function*(){const{direction:e}=yield(0,a.getStore)(),t="ltr"===e?"rtl":"ltr",r=document.getElementById("prompt-textarea");r&&(r.style.direction=t);const o=document.querySelector("div.h-full > section > main")||document.querySelector("div.h-full > section > section"),d=null==o?void 0:o.querySelector(".markdown.prose");d&&(d.style.direction=t,d.classList.remove("ltr"===e?"infi-canvasContainer-ltr":"infi-canvasContainer-rtl"),d.classList.add("ltr"===e?"infi-canvasContainer-rtl":"infi-canvasContainer-ltr")),yield function(e){return n(this,void 0,void 0,(function*(){const t=document.querySelector(".infi-direction-button");t&&(t.ariaLabel=(0,i.t)("ltr"===e?"SWITCH_TO_LTR":"SWITCH_TO_RTL"),t.setAttribute("data-tooltip",(0,i.t)("ltr"===e?"SWITCH_TO_LTR":"SWITCH_TO_RTL")),t.innerHTML="ltr"===e?c.default:s.default)}))}(e),yield(0,a.setDirection)(t)}))};const i=r(6907),a=r(2997),s=o(r(6707)),c=o(r(571))},9972:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,s)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.handleMathDirection=function(){return n(this,void 0,void 0,(function*(){const{direction:e}=yield(0,o.getStore)(),t="ltr"===e?"rtl":"ltr",r=document.querySelectorAll(".katex-display"),n=Array.from(document.querySelectorAll("span.katex")).filter((e=>!e.closest(".katex-display")));r.forEach((e=>{"ltr"===t?e.classList.add("infi-katex-display-html"):e.classList.remove("infi-katex-display-html")})),n.forEach((e=>{"ltr"===t?e.classList.add("infi-katex-html"):e.classList.remove("infi-katex-html")}))}))};const o=r(2997)},8685:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,s)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.handlePlaceholderDirection=function(){return n(this,void 0,void 0,(function*(){const{direction:e}=yield(0,i.getStore)();if(!document.querySelector("div#prompt-textarea p.placeholder"))return;const t=`\n      p.placeholder[data-placeholder]::after {\n        content: "${(0,o.t)("CHATGPT_PROMPT_PLACEHOLDER")}" !important;\n      }\n      p.placeholder[data-placeholder] {\n        direction: ${e} !important;\n      }\n    `;let r=document.getElementById("infi-prompts-placeholder-style");r&&(r.textContent=t)}))};const o=r(6907),i=r(2997)},1867:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,s)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.insertDirectionButton=function(){return n(this,void 0,void 0,(function*(){const e=document.querySelector(".infi-direction-button"),t=document.querySelector('button[data-testid="profile-button"]'),r=document.querySelector("div.h-full > section > main")||document.querySelector("div.h-full > section > section"),s=null==t?void 0:t.closest("div"),c=!!(null==s?void 0:s.querySelector(".infi-direction-button")),d=!r&&!e,l=!!r&&!c;(d||l)&&(null==e||e.remove(),yield(0,i.setDirection)("ltr"),d?yield function(){return n(this,void 0,void 0,(function*(){const e=document.querySelector('button[data-testid="profile-button"]');if(!e)return;const t=e.closest("div");if(!t)return;const{direction:r}=yield(0,i.getStore)(),n="ltr"===r,s=document.createElement("div");s.innerHTML=(0,a.directionButtonHTML)({t:o.t,direction:n?"ltr":"rtl"});const c=s.firstElementChild;c&&t.prepend(c)}))}():l&&(yield function(){return n(this,void 0,void 0,(function*(){var e;const t=(null===(e=document.querySelector('button[data-testid="profile-button"]'))||void 0===e?void 0:e.closest("div"))||document.querySelector("div.h-full > section > header > div:last-of-type");if(!t)return;const{direction:r}=yield(0,i.getStore)(),n="ltr"===r,s=document.createElement("div");s.classList.add("transition-opacity","duration-500"),s.innerHTML=(0,a.directionButtonHTML)({t:o.t,direction:n?"ltr":"rtl"}),t.prepend(s)}))}()))}))};const o=r(6907),i=r(2997),a=r(227)},6907:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.translations=t.setTranslations=void 0,t.t=function(e,t){const o=r[e];if(void 0!==o){if(t){return Object.keys(t).reduce(((e,r)=>{const o=t[r];if(void 0===o)return e;if("object"!=typeof o||null===o){const t=new RegExp(`{{${r}}}`,"g");return e.replace(t,String(o))}if("tagName"in o&&"content"in o){const{tagName:t,content:i,attributes:a}=o,s=a?Object.entries(a).map((([e,t])=>`${e}="${n(t)}"`)).join(" "):"",c=`<${t}${s?" "+s:""}>${n(i)}</${t}>`;return e.replace(new RegExp(`{{${r}}}`,"g"),c)}return e}),o)}return o}return e};let r={};t.translations=r;function n(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,(e=>t[e]))}t.setTranslations=e=>{t.translations=r=e}},2997:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,s)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.setDirection=t.setSelectedPromptLibraryItem=t.setSelectedMediaItem=t.setMediaGalleryActiveButton=t.setGTPsAccordionInterval=t.setPreviousModal=t.setChainData=t.setChainId=t.setChains=t.setPromptId=t.setPrompts=t.shouldShowCheckbox=t.setInjectedTabs=t.setSharedGPTs=t.setGPTs=t.setSelectedFolder=t.setFolders=t.setPinnedFolders=t.setPinnedChats=t.setSidebarClickListenerAdded=t.setSelectedItems=t.setSelectedModalType=t.setBatchAction=t.setSelectedManageTabsItem=t.setIsPaidUser=t.getAccountId=t.getServerToken=t.setServerToken=t.getAuthToken=t.setAuthToken=t.setAccountId=t.clearStorage=t.getIsResetChatHistory=t.setIsResetChatHistory=t.getStore=t.setInitialStore=void 0;const o=r(2948),i=r(3120);t.setInitialStore=()=>n(void 0,void 0,void 0,(function*(){const e={[o.CONSTANTS.ECRYPTED_STORAGE_DATA.IS_PAID_USER]:!1,selectedItems:[],selectedManageTabsItem:o.CONSTANTS.MANAGE_TABS_ITEMS.ACTIVE_CHATS,selectedModalType:void 0,sidebarClickListenerAdded:!1,folders:[],selectedFolder:void 0,injectedTabs:!1,prompts:[],selectedPrompt:void 0,chains:[],selectedChain:void 0,chainData:void 0,previousModal:void 0,batchAction:void 0,pinnedChats:{},pinnedFolders:{},GPTsAccordionInterval:void 0,mediaGalleryActiveButton:o.CONSTANTS.MEDIA_GALLERY.ACTIVE_BUTTON.DALL_E,selectedMediaItem:void 0,selectedPromptLibraryItem:void 0,direction:"ltr",GPTs:[],sharedGPTs:[]};yield chrome.storage.local.set({store:e})}));t.getStore=()=>n(void 0,void 0,void 0,(function*(){try{const e=yield chrome.storage.local.get("store");return(null==e?void 0:e.store)||{}}catch(e){return{}}}));t.setIsResetChatHistory=(...e)=>n(void 0,[...e],void 0,(function*(e=!0){yield chrome.storage.local.set({isResetChatHistory:e})}));t.getIsResetChatHistory=()=>n(void 0,void 0,void 0,(function*(){var e;return null!==(e=(yield chrome.storage.local.get("isResetChatHistory")).isResetChatHistory)&&void 0!==e&&e}));t.clearStorage=()=>n(void 0,void 0,void 0,(function*(){yield(0,t.setInitialStore)()}));t.setAccountId=e=>n(void 0,void 0,void 0,(function*(){yield chrome.storage.local.set({accountID:e})}));t.setAuthToken=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,i.createExtensionServerToken)(e);yield(0,t.setServerToken)(r),yield chrome.storage.local.set({authToken:e})}));t.getAuthToken=()=>n(void 0,void 0,void 0,(function*(){const e=yield chrome.storage.local.get("authToken");return(null==e?void 0:e.authToken)||null}));t.setServerToken=e=>n(void 0,void 0,void 0,(function*(){yield chrome.storage.local.set({serverToken:e})}));t.getServerToken=()=>n(void 0,void 0,void 0,(function*(){const e=yield chrome.storage.local.get("serverToken");return(null==e?void 0:e.serverToken)||null}));t.getAccountId=()=>n(void 0,void 0,void 0,(function*(){const e=yield chrome.storage.local.get("accountID");return(null==e?void 0:e.accountID)||null}));t.setIsPaidUser=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r[o.CONSTANTS.ECRYPTED_STORAGE_DATA.IS_PAID_USER]=e,yield chrome.storage.local.set({store:r})}));t.setSelectedManageTabsItem=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.selectedManageTabsItem=e,r.selectedItems=[],yield chrome.storage.local.set({store:r})}));t.setBatchAction=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.batchAction=e,yield chrome.storage.local.set({store:r})}));t.setSelectedModalType=(e,...r)=>n(void 0,[e,...r],void 0,(function*(e,r=!0){const n=yield(0,t.getStore)();n.selectedModalType=e,r&&(n.selectedItems=[]),yield chrome.storage.local.set({store:n})}));t.setSelectedItems=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.selectedItems=e,yield chrome.storage.local.set({store:r})}));t.setSidebarClickListenerAdded=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.sidebarClickListenerAdded=e,yield chrome.storage.local.set({store:r})}));t.setPinnedChats=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.pinnedChats=e,yield chrome.storage.local.set({store:r})}));t.setPinnedFolders=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.pinnedFolders=e,yield chrome.storage.local.set({store:r})}));t.setFolders=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.folders=e,yield chrome.storage.local.set({store:r})}));t.setSelectedFolder=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.selectedFolder=e,yield chrome.storage.local.set({store:r})}));t.setGPTs=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.GPTs=e,yield chrome.storage.local.set({store:r})}));t.setSharedGPTs=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.sharedGPTs=e,yield chrome.storage.local.set({store:r})}));t.setInjectedTabs=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.injectedTabs=e,yield chrome.storage.local.set({store:r})}));t.shouldShowCheckbox=()=>n(void 0,void 0,void 0,(function*(){const e=yield(0,t.getStore)(),{selectedManageTabsItem:r,selectedModalType:n}=e;return[o.CONSTANTS.MANAGE_TABS_ITEMS.ACTIVE_CHATS,o.CONSTANTS.MANAGE_TABS_ITEMS.ARCHIVED_CHATS,o.CONSTANTS.MANAGE_FOLDER_ITEMS.ADD_CHATS,o.CONSTANTS.MANAGE_FOLDER_ITEMS.REMOVE_CHATS].some((e=>e===r))||"MANAGE_FOLDERS"===n||"MANAGE_PROMPTS"===n}));t.setPrompts=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.prompts=e,yield chrome.storage.local.set({store:r})}));t.setPromptId=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.selectedPrompt=e,yield chrome.storage.local.set({store:r})}));t.setChains=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.chains=e,yield chrome.storage.local.set({store:r})}));t.setChainId=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.selectedChain=e,yield chrome.storage.local.set({store:r})}));t.setChainData=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.chainData=e,yield chrome.storage.local.set({store:r})}));t.setPreviousModal=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.previousModal=e,yield chrome.storage.local.set({store:r})}));t.setGTPsAccordionInterval=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.GPTsAccordionInterval=e,yield chrome.storage.local.set({store:r})}));t.setMediaGalleryActiveButton=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.mediaGalleryActiveButton=e,yield chrome.storage.local.set({store:r})}));t.setSelectedMediaItem=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.selectedMediaItem=e,yield chrome.storage.local.set({store:r})}));t.setSelectedPromptLibraryItem=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.selectedPromptLibraryItem=e,yield chrome.storage.local.set({store:r})}));t.setDirection=e=>n(void 0,void 0,void 0,(function*(){const r=yield(0,t.getStore)();r.direction=e,yield chrome.storage.local.set({store:r})}))},2948:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CONSTANTS=void 0,t.CONSTANTS={API:{HOST:"chatgpt.com",CHATGPT:"https://chatgpt.com",CHATGPT_BACKEND_CONVERSATION:"https://chatgpt.com/backend-api/conversation",CHATGPT_BACKEND_CONVERSATIONS:"https://chatgpt.com/backend-api/conversations",CHATGPT_BACKEND_STOP_CONVERSATION:"https://chatgpt.com/backend-api/stop_conversation",CHATGPT_ACCOUNT_CHECK:"https://chatgpt.com/backend-api/accounts/check/",CHATGPT_BACKEND_VOICE:"https://chatgpt.com/backend-api/synthesize",CHATGPT_BACKEND_PROJECTS:"https://chatgpt.com/backend-api/gizmos/snorlax/sidebar",CHATGPT_BACKEND_GIZMOS:"https://chatgpt.com/backend-api/gizmos",CHATGPT_BACKEND_GET_GIZMOS:"https://chatgpt.com/backend-api/gizmos/bootstrap",CHATGPT_BACKEND_SEARCH_GIZMOS:"https://chatgpt.com/backend-api/gizmos/search",FETCH_CONVERSATION:{RETRIES:3,INITIAL_DELAY:1e3}},DATABASE:{DB_NAME:"ChatHistoryDB",IMAGE_STORE_NAME:"images",CONVERSATION_STORE_NAME:"conversations",VERSION:6,MAX_IMAGE_RECORDS:1e3},MODAL_TYPES:{SEARCH_HISTORY:"SEARCH_HISTORY",MANAGE_CHATS:"MANAGE_CHATS",MANAGE_FOLDERS:"MANAGE_FOLDERS",MANAGE_PROMPTS:"MANAGE_PROMPTS",MANAGE_FOLDER:"MANAGE_FOLDER",ADD_CHAT:"ADD_CHAT",ADD_FOLDER:"ADD_FOLDER",ADD_GPT:"ADD_GPT",ADD_PROMPT:"ADD_PROMPT",ADD_CHAIN:"ADD_CHAIN",SETTINGS:"SETTINGS",PREMIUM_REQUIRED:"PREMIUM_REQUIRED",PREMIUM_LIMIT:"PREMIUM_LIMIT",EXPORT_CHAT:"EXPORT_CHAT",MOVE_CHAT:"MOVE_CHAT",MEDIA_GALLERY:"MEDIA_GALLERY",MEDIA_GALLERY_PREMIUM_ONLY:"MEDIA_GALLERY_PREMIUM_ONLY",PROMPT_LIBRARY:"PROMPT_LIBRARY",PROMPT_LIBRARY_SAVE_PROMPT:"PROMPT_LIBRARY_SAVE_PROMPT",PROMPT_DYNAMIC_VALUES:"PROMPT_DYNAMIC_VALUES",CHAIN_DYNAMIC_VALUES:"CHAIN_DYNAMIC_VALUES"},MANAGE_TABS_ITEMS:{ACTIVE_CHATS:"ACTIVE_CHATS",ARCHIVED_CHATS:"ARCHIVED_CHATS"},MANAGE_FOLDER_ITEMS:{VIEW_CHATS:"VIEW_CHATS",ADD_CHATS:"ADD_CHATS",REMOVE_CHATS:"REMOVE_CHATS"},CONVERATION_STATUS:{ARCHIVE:"archive",DELETE:"delete",UNARCHIVE:"unarchive"},CHROME_RUNTIME_DETAILS:{INSTALL:"install"},ACTIONS:{PATCH_CONVERSATION:"handleConversationPatchRequest",NEW_MESSAGE_SENT:"newMessageSent",CHANGE_LANGUAGE:"changeLanguage",GET_BACKEND_DATA_AND_LISTEN:"getBackendDataAndListen",INJECT_SIDETABS:"injectSideTabs",BATCH_CHATS_ACTION:"batchChatsAction",RESET_INDEXEDB:"reset_indexedb",SEND_CHAIN_NEXT_PROMPT:"sendChainNextPrompt",STOP_CHAIN_NEXT_PROMPT:"stopChainNextPrompt"},HTTP_REQUESTS:{XML:"xmlhttprequest",POST:"POST",GET:"GET",PATCH:"PATCH",DELETE:"DELETE"},HEADERS:{AUTH:"authorization",CHATGPT_ACCOUNT_ID:"chatgpt-account-id",EXTENSION_REQUEST:"X-Extension-Request"},WEB_REQUEST_TYPE:{REQUEST_HEADERS:"requestHeaders",REQEUST_BODY:"requestBody"},CHROME_TAB_STATUS:{COMPLETE:"complete"},ACCOUNT_ID:{ACCOUNT:"_account",PERSONAL:'"personal"'},VOICE_OPTIONS:{Ember:"ember",Cove:"cove",Sol:"glimmer",Breeze:"breeze",Maple:"maple",Spruce:"orbit",Vale:"vale",Juniper:"juniper",Arbor:"fathom"},LANGUAGES:{ARABIC:"ar",GERMAN:"de",ENGLISH:"en",SPANISH:"es",FRENCH:"fr",HEBREW:"he",HINDI:"hi",ITALIAN:"it",JAPANESE:"ja",CHINESE:"zh"},BREAKPOINT_WIDTH:768,MANAGE_FOLDERS:{ADD_FOLDER:{MAX_NAME_LENGTH:40}},MANAGE_PROMPTS:{EDIT_PROMPT:{MAX_NAME_LENGTH:100,MAX_CONTENT_LENGTH:6e3},EDIT_CHAIN:{MAX_NAME_LENGTH:100,MAX_CONTENT_LENGTH:6e3,MAX_CHAINED_PROMPT_ITEMS:10}},DEBOUNCE_DELAY:300,PLANS:{FREE:{MAX_SEARCH_RESULTS:5}},ECRYPTED_STORAGE_DATA:{IS_PAID_USER:"-r.6es£Jr1U0"},MEDIA_GALLERY:{ACTIVE_BUTTON:{DALL_E:"DALL_E",CHARTS:"CHARTS"},PREVIEW_IMAGE:"https://media.happyhourhub.co/ChatGPT-Toolbox-Media/media-gallery-preview.png",LIMIT:15},LIST:{MAX_LABEL_LENGTH:34},ADD_GPT:{DESCRIPTION_LENGTH:77},PROMPT_LIBRARY:{LIMIT:15,DEFAULT_CATEGORY:"marketing",PROMPT_TEXT_MAX_LENGTH:168,FREE_CATEGORY_LIMIT:5},LOCAL_STORAGE:{EXPAND_FEATURES_TAB:"infi-expand-features-tab",EXPAND_GPTS:"infi-expand-gpts",EXPAND_PINNED_FOLDERS:"infi-expand-pinned-folders",EXPAND_PINNED_CHATS:"infi-expand-pinned-chats",INFO_AND_UPDATES_VERSION:"chatgpt-toolbox-info-and-updates-version",FREE_USER_MODAL:"chatgpt-toolbox-free-user-modal"},PROMPT_VALUES:{MAX_LABEL_LENGTH:22},CHAIN_VALUES:{MAX_PROMPT_NAME_LENGTH:45,MAX_LABEL_LENGTH:22}}},3120:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,s)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.createExtensionServerToken=function(e){return n(this,void 0,void 0,(function*(){var t;if(!e)return null;e=e.split(" ")[1];const r=yield(0,i.getAuthToken)(),n=r?r.split(" ")[1]:null,a=yield(0,i.getServerToken)(),s=(new TextEncoder).encode("G1J!QQcJE0Mo4=ED,!JWcv9Rk6Lz1!");if(a&&n&&n===e)try{const{payload:e}=yield(0,o.jwtVerify)(a,s,{audience:"chatgpt-toolbox-extension-server"});return a}catch(e){}const d=yield c(e);if(!d)return null;const l=null===(t=d["https://api.openai.com/profile"])||void 0===t?void 0:t.email;if(!l)return null;return yield new o.SignJWT({email:l}).setProtectedHeader({alg:"HS256"}).setAudience("chatgpt-toolbox-extension-server").setExpirationTime("10d").sign(s)}))};const o=r(5948),i=r(2997),a=r(5381);function s(e){return n(this,void 0,void 0,(function*(){const t=function(e){if("https://auth0.openai.com/"===e)return"https://auth0.openai.com/.well-known/jwks.json";if("https://auth.openai.com"===e)return"https://auth.openai.com/.well-known/jwks.json";throw new Error(`Unsupported issuer: ${e}`)}(e);return yield(0,a.fetchJWKSFromServer)(t)}))}function c(e){return n(this,arguments,void 0,(function*(e,t=0){try{const i=function(e){const[t]=e.split("."),r=d(t);return JSON.parse(r)}(e),a=function(e){const[,t]=e.split("."),r=d(t);return JSON.parse(r)}(e);if(!a.iss)throw new Error("Missing issuer in token payload");const l=a.iss,u=["https://api.openai.com/v1","https://openai.openai.auth0app.com/userinfo"],h=null==i?void 0:i.kid;if(!h)throw new Error("No 'kid' in token header");let p;try{p=yield function(e,t){return n(this,void 0,void 0,(function*(){const r=(yield s(e)).keys.find((e=>e.kid===t&&"RSA"===e.kty));if(!r)throw new Error("Signing key not found");return r}))}(l,h)}catch(n){if(t<3&&n.message.includes("Signing key not found"))return yield(r=300,new Promise((e=>setTimeout(e,r)))),yield c(e,t+1);throw n}const y=(0,o.createLocalJWKSet)({keys:[p]}),{payload:f}=yield(0,o.jwtVerify)(e,y,{audience:u});return f}catch(e){return null}var r}))}function d(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");const r=4-t.length%4;return 4!==r&&(t+="=".repeat(r)),atob(t)}},5074:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,s)}c((n=n.apply(e,t||[])).next())}))},o=this&&this.__rest||function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r};Object.defineProperty(t,"__esModule",{value:!0}),t.fetchFromAPI=function(e,t){return n(this,arguments,void 0,(function*(e,t,r={}){try{let n="",a="";if(t){const e=yield(0,i.getServerToken)();if(!e)throw new Error("No token provided");n=e,a=(yield(0,i.getAccountId)())||""}const s=`${e}${e.includes("?")?"&":"?"}cacheBuster=${(new Date).getTime()}`,{headers:c}=r,d=o(r,["headers"]),l=yield fetch(s,Object.assign({headers:Object.assign({Authorization:n,"Chatgpt-Account-Id":a},c)},d));if(!l.ok)throw new Error(`HTTP error: ${l.status}`);return yield l.json()}catch(e){return}}))};const i=r(2997)},7392:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.manageEventListeners=function(e,t,n,o){let i=r.get(n);if(!i){i=new Map,r.set(n,i);const e=new MutationObserver((()=>{document.body.contains(n)||(i.forEach(((e,t)=>{n.removeEventListener(t,i.get(t))})),r.delete(n),e.disconnect())}));e.observe(document.body,{childList:!0,subtree:!0})}const a=i.get(e);a&&n.removeEventListener(e,a,o);i.set(e,t),n.addEventListener(e,t,o)};const r=new Map},5948:(e,t,r)=>{r.r(t),r.d(t,{CompactEncrypt:()=>gt,CompactSign:()=>_t,EmbeddedJWK:()=>Mt,EncryptJWT:()=>kt,FlattenedEncrypt:()=>nt,FlattenedSign:()=>vt,GeneralEncrypt:()=>it,GeneralSign:()=>bt,SignJWT:()=>Pt,UnsecuredJWT:()=>$t,base64url:()=>o,calculateJwkThumbprint:()=>Rt,calculateJwkThumbprintUri:()=>Ot,compactDecrypt:()=>qe,compactVerify:()=>lt,createLocalJWKSet:()=>Jt,createRemoteJWKSet:()=>jt,cryptoRuntime:()=>Zt,decodeJwt:()=>qt,decodeProtectedHeader:()=>Xt,errors:()=>n,experimental_jwksCache:()=>Bt,exportJWK:()=>tt,exportPKCS8:()=>et,exportSPKI:()=>Ze,flattenedDecrypt:()=>Xe,flattenedVerify:()=>dt,generalDecrypt:()=>Ye,generalVerify:()=>ut,generateKeyPair:()=>zt,generateSecret:()=>Qt,importJWK:()=>Ne,importPKCS8:()=>We,importSPKI:()=>De,importX509:()=>Ke,jwksCache:()=>Ut,jwtDecrypt:()=>At,jwtVerify:()=>mt});var n={};r.r(n),r.d(n,{JOSEAlgNotAllowed:()=>_,JOSEError:()=>g,JOSENotSupported:()=>T,JWEDecryptionFailed:()=>b,JWEInvalid:()=>C,JWKInvalid:()=>k,JWKSInvalid:()=>I,JWKSMultipleMatchingKeys:()=>O,JWKSNoMatchingKey:()=>R,JWKSTimeout:()=>M,JWSInvalid:()=>H,JWSSignatureVerificationFailed:()=>D,JWTClaimValidationFailed:()=>S,JWTExpired:()=>v,JWTInvalid:()=>P});var o={};r.r(o),r.d(o,{decode:()=>Vt,encode:()=>Ft});const i=crypto,a=e=>e instanceof CryptoKey,s=async(e,t)=>{const r=`SHA-${e.slice(-3)}`;return new Uint8Array(await i.subtle.digest(r,t))},c=new TextEncoder,d=new TextDecoder,l=2**32;function u(...e){const t=e.reduce(((e,{length:t})=>e+t),0),r=new Uint8Array(t);let n=0;for(const t of e)r.set(t,n),n+=t.length;return r}function h(e,t,r){if(t<0||t>=l)throw new RangeError(`value must be >= 0 and <= ${l-1}. Received ${t}`);e.set([t>>>24,t>>>16,t>>>8,255&t],r)}function p(e){const t=Math.floor(e/l),r=e%l,n=new Uint8Array(8);return h(n,t,0),h(n,r,4),n}function y(e){const t=new Uint8Array(4);return h(t,e),t}function f(e){return u(y(e.length),e)}const w=e=>{let t=e;"string"==typeof t&&(t=c.encode(t));const r=[];for(let e=0;e<t.length;e+=32768)r.push(String.fromCharCode.apply(null,t.subarray(e,e+32768)));return btoa(r.join(""))},E=e=>w(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),m=e=>{const t=atob(e),r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e);return r},A=e=>{let t=e;t instanceof Uint8Array&&(t=d.decode(t)),t=t.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return m(t)}catch{throw new TypeError("The input to be decoded is not correctly encoded.")}};class g extends Error{constructor(e,t){super(e,t),this.code="ERR_JOSE_GENERIC",this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}}g.code="ERR_JOSE_GENERIC";class S extends g{constructor(e,t,r="unspecified",n="unspecified"){super(e,{cause:{claim:r,reason:n,payload:t}}),this.code="ERR_JWT_CLAIM_VALIDATION_FAILED",this.claim=r,this.reason=n,this.payload=t}}S.code="ERR_JWT_CLAIM_VALIDATION_FAILED";class v extends g{constructor(e,t,r="unspecified",n="unspecified"){super(e,{cause:{claim:r,reason:n,payload:t}}),this.code="ERR_JWT_EXPIRED",this.claim=r,this.reason=n,this.payload=t}}v.code="ERR_JWT_EXPIRED";class _ extends g{constructor(){super(...arguments),this.code="ERR_JOSE_ALG_NOT_ALLOWED"}}_.code="ERR_JOSE_ALG_NOT_ALLOWED";class T extends g{constructor(){super(...arguments),this.code="ERR_JOSE_NOT_SUPPORTED"}}T.code="ERR_JOSE_NOT_SUPPORTED";class b extends g{constructor(e="decryption operation failed",t){super(e,t),this.code="ERR_JWE_DECRYPTION_FAILED"}}b.code="ERR_JWE_DECRYPTION_FAILED";class C extends g{constructor(){super(...arguments),this.code="ERR_JWE_INVALID"}}C.code="ERR_JWE_INVALID";class H extends g{constructor(){super(...arguments),this.code="ERR_JWS_INVALID"}}H.code="ERR_JWS_INVALID";class P extends g{constructor(){super(...arguments),this.code="ERR_JWT_INVALID"}}P.code="ERR_JWT_INVALID";class k extends g{constructor(){super(...arguments),this.code="ERR_JWK_INVALID"}}k.code="ERR_JWK_INVALID";class I extends g{constructor(){super(...arguments),this.code="ERR_JWKS_INVALID"}}I.code="ERR_JWKS_INVALID";class R extends g{constructor(e="no applicable key found in the JSON Web Key Set",t){super(e,t),this.code="ERR_JWKS_NO_MATCHING_KEY"}}R.code="ERR_JWKS_NO_MATCHING_KEY";class O extends g{constructor(e="multiple matching keys found in the JSON Web Key Set",t){super(e,t),this.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS"}}Symbol.asyncIterator,O.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS";class M extends g{constructor(e="request timed out",t){super(e,t),this.code="ERR_JWKS_TIMEOUT"}}M.code="ERR_JWKS_TIMEOUT";class D extends g{constructor(e="signature verification failed",t){super(e,t),this.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED"}}D.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";const K=i.getRandomValues.bind(i);function W(e){switch(e){case"A128GCM":case"A128GCMKW":case"A192GCM":case"A192GCMKW":case"A256GCM":case"A256GCMKW":return 96;case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return 128;default:throw new T(`Unsupported JWE Algorithm: ${e}`)}}const N=(e,t)=>{if(t.length<<3!==W(e))throw new C("Invalid Initialization Vector length")},J=(e,t)=>{const r=e.byteLength<<3;if(r!==t)throw new C(`Invalid Content Encryption Key length. Expected ${t} bits, got ${r} bits`)},x=(e,t)=>{if(!(e instanceof Uint8Array))throw new TypeError("First argument must be a buffer");if(!(t instanceof Uint8Array))throw new TypeError("Second argument must be a buffer");if(e.length!==t.length)throw new TypeError("Input buffers must have the same length");const r=e.length;let n=0,o=-1;for(;++o<r;)n|=e[o]^t[o];return 0===n};function L(e,t="algorithm.name"){return new TypeError(`CryptoKey does not support this operation, its ${t} must be ${e}`)}function U(e,t){return e.name===t}function G(e){return parseInt(e.name.slice(4),10)}function j(e,t){if(t.length&&!t.some((t=>e.usages.includes(t)))){let e="CryptoKey does not support this operation, its usages must include ";if(t.length>2){const r=t.pop();e+=`one of ${t.join(", ")}, or ${r}.`}else 2===t.length?e+=`one of ${t[0]} or ${t[1]}.`:e+=`${t[0]}.`;throw new TypeError(e)}}function B(e,t,...r){switch(t){case"HS256":case"HS384":case"HS512":{if(!U(e.algorithm,"HMAC"))throw L("HMAC");const r=parseInt(t.slice(2),10);if(G(e.algorithm.hash)!==r)throw L(`SHA-${r}`,"algorithm.hash");break}case"RS256":case"RS384":case"RS512":{if(!U(e.algorithm,"RSASSA-PKCS1-v1_5"))throw L("RSASSA-PKCS1-v1_5");const r=parseInt(t.slice(2),10);if(G(e.algorithm.hash)!==r)throw L(`SHA-${r}`,"algorithm.hash");break}case"PS256":case"PS384":case"PS512":{if(!U(e.algorithm,"RSA-PSS"))throw L("RSA-PSS");const r=parseInt(t.slice(2),10);if(G(e.algorithm.hash)!==r)throw L(`SHA-${r}`,"algorithm.hash");break}case"EdDSA":if("Ed25519"!==e.algorithm.name&&"Ed448"!==e.algorithm.name)throw L("Ed25519 or Ed448");break;case"ES256":case"ES384":case"ES512":{if(!U(e.algorithm,"ECDSA"))throw L("ECDSA");const r=function(e){switch(e){case"ES256":return"P-256";case"ES384":return"P-384";case"ES512":return"P-521";default:throw new Error("unreachable")}}(t);if(e.algorithm.namedCurve!==r)throw L(r,"algorithm.namedCurve");break}default:throw new TypeError("CryptoKey does not support this operation")}j(e,r)}function $(e,t,...r){switch(t){case"A128GCM":case"A192GCM":case"A256GCM":{if(!U(e.algorithm,"AES-GCM"))throw L("AES-GCM");const r=parseInt(t.slice(1,4),10);if(e.algorithm.length!==r)throw L(r,"algorithm.length");break}case"A128KW":case"A192KW":case"A256KW":{if(!U(e.algorithm,"AES-KW"))throw L("AES-KW");const r=parseInt(t.slice(1,4),10);if(e.algorithm.length!==r)throw L(r,"algorithm.length");break}case"ECDH":switch(e.algorithm.name){case"ECDH":case"X25519":case"X448":break;default:throw L("ECDH, X25519, or X448")}break;case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":if(!U(e.algorithm,"PBKDF2"))throw L("PBKDF2");break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":{if(!U(e.algorithm,"RSA-OAEP"))throw L("RSA-OAEP");const r=parseInt(t.slice(9),10)||1;if(G(e.algorithm.hash)!==r)throw L(`SHA-${r}`,"algorithm.hash");break}default:throw new TypeError("CryptoKey does not support this operation")}j(e,r)}function F(e,t,...r){if((r=r.filter(Boolean)).length>2){const t=r.pop();e+=`one of type ${r.join(", ")}, or ${t}.`}else 2===r.length?e+=`one of type ${r[0]} or ${r[1]}.`:e+=`of type ${r[0]}.`;return null==t?e+=` Received ${t}`:"function"==typeof t&&t.name?e+=` Received function ${t.name}`:"object"==typeof t&&null!=t&&t.constructor?.name&&(e+=` Received an instance of ${t.constructor.name}`),e}const V=(e,...t)=>F("Key must be ",e,...t);function X(e,t,...r){return F(`Key for the ${e} algorithm must be `,t,...r)}const q=e=>!!a(e)||"KeyObject"===e?.[Symbol.toStringTag],Y=["CryptoKey"];const z=async(e,t,r,n,o,s)=>{if(!(a(t)||t instanceof Uint8Array))throw new TypeError(V(t,...Y,"Uint8Array"));if(!n)throw new C("JWE Initialization Vector missing");if(!o)throw new C("JWE Authentication Tag missing");switch(N(e,n),e){case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return t instanceof Uint8Array&&J(t,parseInt(e.slice(-3),10)),async function(e,t,r,n,o,a){if(!(t instanceof Uint8Array))throw new TypeError(V(t,"Uint8Array"));const s=parseInt(e.slice(1,4),10),c=await i.subtle.importKey("raw",t.subarray(s>>3),"AES-CBC",!1,["decrypt"]),d=await i.subtle.importKey("raw",t.subarray(0,s>>3),{hash:"SHA-"+(s<<1),name:"HMAC"},!1,["sign"]),l=u(a,n,r,p(a.length<<3)),h=new Uint8Array((await i.subtle.sign("HMAC",d,l)).slice(0,s>>3));let y,f;try{y=x(o,h)}catch{}if(!y)throw new b;try{f=new Uint8Array(await i.subtle.decrypt({iv:n,name:"AES-CBC"},c,r))}catch{}if(!f)throw new b;return f}(e,t,r,n,o,s);case"A128GCM":case"A192GCM":case"A256GCM":return t instanceof Uint8Array&&J(t,parseInt(e.slice(1,4),10)),async function(e,t,r,n,o,a){let s;t instanceof Uint8Array?s=await i.subtle.importKey("raw",t,"AES-GCM",!1,["decrypt"]):($(t,e,"decrypt"),s=t);try{return new Uint8Array(await i.subtle.decrypt({additionalData:a,iv:n,name:"AES-GCM",tagLength:128},s,u(r,o)))}catch{throw new b}}(e,t,r,n,o,s);default:throw new T("Unsupported JWE Content Encryption Algorithm")}},Q=(...e)=>{const t=e.filter(Boolean);if(0===t.length||1===t.length)return!0;let r;for(const e of t){const t=Object.keys(e);if(r&&0!==r.size)for(const e of t){if(r.has(e))return!1;r.add(e)}else r=new Set(t)}return!0};function Z(e){if("object"!=typeof(t=e)||null===t||"[object Object]"!==Object.prototype.toString.call(e))return!1;var t;if(null===Object.getPrototypeOf(e))return!0;let r=e;for(;null!==Object.getPrototypeOf(r);)r=Object.getPrototypeOf(r);return Object.getPrototypeOf(e)===r}const ee=[{hash:"SHA-256",name:"HMAC"},!0,["sign"]];function te(e,t){if(e.algorithm.length!==parseInt(t.slice(1,4),10))throw new TypeError(`Invalid key size for alg: ${t}`)}function re(e,t,r){if(a(e))return $(e,t,r),e;if(e instanceof Uint8Array)return i.subtle.importKey("raw",e,"AES-KW",!0,[r]);throw new TypeError(V(e,...Y,"Uint8Array"))}const ne=async(e,t,r)=>{const n=await re(t,e,"wrapKey");te(n,e);const o=await i.subtle.importKey("raw",r,...ee);return new Uint8Array(await i.subtle.wrapKey("raw",o,n,"AES-KW"))},oe=async(e,t,r)=>{const n=await re(t,e,"unwrapKey");te(n,e);const o=await i.subtle.unwrapKey("raw",r,n,"AES-KW",...ee);return new Uint8Array(await i.subtle.exportKey("raw",o))};async function ie(e,t,r,n,o=new Uint8Array(0),d=new Uint8Array(0)){if(!a(e))throw new TypeError(V(e,...Y));if($(e,"ECDH"),!a(t))throw new TypeError(V(t,...Y));$(t,"ECDH","deriveBits");const l=u(f(c.encode(r)),f(o),f(d),y(n));let h;h="X25519"===e.algorithm.name?256:"X448"===e.algorithm.name?448:Math.ceil(parseInt(e.algorithm.namedCurve.substr(-3),10)/8)<<3;return async function(e,t,r){const n=Math.ceil((t>>3)/32),o=new Uint8Array(32*n);for(let t=0;t<n;t++){const n=new Uint8Array(4+e.length+r.length);n.set(y(t+1)),n.set(e,4),n.set(r,4+e.length),o.set(await s("sha256",n),32*t)}return o.slice(0,t>>3)}(new Uint8Array(await i.subtle.deriveBits({name:e.algorithm.name,public:e},t,h)),n,l)}function ae(e){if(!a(e))throw new TypeError(V(e,...Y));return["P-256","P-384","P-521"].includes(e.algorithm.namedCurve)||"X25519"===e.algorithm.name||"X448"===e.algorithm.name}async function se(e,t,r,n){!function(e){if(!(e instanceof Uint8Array)||e.length<8)throw new C("PBES2 Salt Input must be 8 or more octets")}(e);const o=function(e,t){return u(c.encode(e),new Uint8Array([0]),t)}(t,e),s=parseInt(t.slice(13,16),10),d={hash:`SHA-${t.slice(8,11)}`,iterations:r,name:"PBKDF2",salt:o},l={length:s,name:"AES-KW"},h=await function(e,t){if(e instanceof Uint8Array)return i.subtle.importKey("raw",e,"PBKDF2",!1,["deriveBits"]);if(a(e))return $(e,t,"deriveBits","deriveKey"),e;throw new TypeError(V(e,...Y,"Uint8Array"))}(n,t);if(h.usages.includes("deriveBits"))return new Uint8Array(await i.subtle.deriveBits(d,h,s));if(h.usages.includes("deriveKey"))return i.subtle.deriveKey(d,h,l,!1,["wrapKey","unwrapKey"]);throw new TypeError('PBKDF2 key "usages" must include "deriveBits" or "deriveKey"')}function ce(e){switch(e){case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":return"RSA-OAEP";default:throw new T(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}const de=(e,t)=>{if(e.startsWith("RS")||e.startsWith("PS")){const{modulusLength:r}=t.algorithm;if("number"!=typeof r||r<2048)throw new TypeError(`${e} requires key modulusLength to be 2048 bits or larger`)}};function le(e){return Z(e)&&"string"==typeof e.kty}const ue=async e=>{if(!e.alg)throw new TypeError('"alg" argument is required when "jwk.alg" is not present');const{algorithm:t,keyUsages:r}=function(e){let t,r;switch(e.kty){case"RSA":switch(e.alg){case"PS256":case"PS384":case"PS512":t={name:"RSA-PSS",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":t={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":t={name:"RSA-OAEP",hash:`SHA-${parseInt(e.alg.slice(-3),10)||1}`},r=e.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new T('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"EC":switch(e.alg){case"ES256":t={name:"ECDSA",namedCurve:"P-256"},r=e.d?["sign"]:["verify"];break;case"ES384":t={name:"ECDSA",namedCurve:"P-384"},r=e.d?["sign"]:["verify"];break;case"ES512":t={name:"ECDSA",namedCurve:"P-521"},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:"ECDH",namedCurve:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new T('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"OKP":switch(e.alg){case"EdDSA":t={name:e.crv},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new T('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;default:throw new T('Invalid or unsupported JWK "kty" (Key Type) Parameter value')}return{algorithm:t,keyUsages:r}}(e),n=[t,e.ext??!1,e.key_ops??r],o={...e};return delete o.alg,delete o.use,i.subtle.importKey("jwk",o,...n)},he=e=>A(e);let pe,ye;const fe=e=>"KeyObject"===e?.[Symbol.toStringTag],we=async(e,t,r,n,o=!1)=>{let i=e.get(t);if(i?.[n])return i[n];const a=await ue({...r,alg:n});return o&&Object.freeze(t),i?i[n]=a:e.set(t,{[n]:a}),a},Ee=(e,t)=>{if(fe(e)){let r=e.export({format:"jwk"});return delete r.d,delete r.dp,delete r.dq,delete r.p,delete r.q,delete r.qi,r.k?he(r.k):(ye||(ye=new WeakMap),we(ye,e,r,t))}if(le(e)){if(e.k)return A(e.k);ye||(ye=new WeakMap);return we(ye,e,e,t,!0)}return e},me=(e,t)=>{if(fe(e)){let r=e.export({format:"jwk"});return r.k?he(r.k):(pe||(pe=new WeakMap),we(pe,e,r,t))}if(le(e)){if(e.k)return A(e.k);pe||(pe=new WeakMap);return we(pe,e,e,t,!0)}return e};function Ae(e){switch(e){case"A128GCM":return 128;case"A192GCM":return 192;case"A256GCM":case"A128CBC-HS256":return 256;case"A192CBC-HS384":return 384;case"A256CBC-HS512":return 512;default:throw new T(`Unsupported JWE Algorithm: ${e}`)}}const ge=e=>K(new Uint8Array(Ae(e)>>3)),Se=(e,t)=>`-----BEGIN ${t}-----\n${(e.match(/.{1,64}/g)||[]).join("\n")}\n-----END ${t}-----`,ve=async(e,t,r)=>{if(!a(r))throw new TypeError(V(r,...Y));if(!r.extractable)throw new TypeError("CryptoKey is not extractable");if(r.type!==e)throw new TypeError(`key is not a ${e} key`);return Se(w(new Uint8Array(await i.subtle.exportKey(t,r))),`${e.toUpperCase()} KEY`)},_e=e=>ve("public","spki",e),Te=e=>ve("private","pkcs8",e),be=(e,t,r=0)=>{0===r&&(t.unshift(t.length),t.unshift(6));const n=e.indexOf(t[0],r);if(-1===n)return!1;const o=e.subarray(n,n+t.length);return o.length===t.length&&(o.every(((e,r)=>e===t[r]))||be(e,t,n+1))},Ce=e=>{switch(!0){case be(e,[42,134,72,206,61,3,1,7]):return"P-256";case be(e,[43,129,4,0,34]):return"P-384";case be(e,[43,129,4,0,35]):return"P-521";case be(e,[43,101,110]):return"X25519";case be(e,[43,101,111]):return"X448";case be(e,[43,101,112]):return"Ed25519";case be(e,[43,101,113]):return"Ed448";default:throw new T("Invalid or unsupported EC Key Curve or OKP Key Sub Type")}},He=async(e,t,r,n,o)=>{let a,s;const c=new Uint8Array(atob(r.replace(e,"")).split("").map((e=>e.charCodeAt(0)))),d="spki"===t;switch(n){case"PS256":case"PS384":case"PS512":a={name:"RSA-PSS",hash:`SHA-${n.slice(-3)}`},s=d?["verify"]:["sign"];break;case"RS256":case"RS384":case"RS512":a={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${n.slice(-3)}`},s=d?["verify"]:["sign"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":a={name:"RSA-OAEP",hash:`SHA-${parseInt(n.slice(-3),10)||1}`},s=d?["encrypt","wrapKey"]:["decrypt","unwrapKey"];break;case"ES256":a={name:"ECDSA",namedCurve:"P-256"},s=d?["verify"]:["sign"];break;case"ES384":a={name:"ECDSA",namedCurve:"P-384"},s=d?["verify"]:["sign"];break;case"ES512":a={name:"ECDSA",namedCurve:"P-521"},s=d?["verify"]:["sign"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{const e=Ce(c);a=e.startsWith("P-")?{name:"ECDH",namedCurve:e}:{name:e},s=d?[]:["deriveBits"];break}case"EdDSA":a={name:Ce(c)},s=d?["verify"]:["sign"];break;default:throw new T('Invalid or unsupported "alg" (Algorithm) value')}return i.subtle.importKey(t,c,a,o?.extractable??!1,s)},Pe=(e,t,r)=>He(/(?:-----(?:BEGIN|END) PRIVATE KEY-----|\s)/g,"pkcs8",e,t,r),ke=(e,t,r)=>He(/(?:-----(?:BEGIN|END) PUBLIC KEY-----|\s)/g,"spki",e,t,r);function Ie(e){const t=[];let r=0;for(;r<e.length;){const n=Re(e.subarray(r));t.push(n),r+=n.byteLength}return t}function Re(e){let t=0,r=31&e[0];if(t++,31===r){for(r=0;e[t]>=128;)r=128*r+e[t]-128,t++;r=128*r+e[t]-128,t++}let n=0;if(e[t]<128)n=e[t],t++;else{if(128===n){for(n=0;0!==e[t+n]||0!==e[t+n+1];){if(n>e.byteLength)throw new TypeError("invalid indefinite form length");n++}const r=t+n+2;return{byteLength:r,contents:e.subarray(t,t+n),raw:e.subarray(0,r)}}{const r=127&e[t];t++,n=0;for(let o=0;o<r;o++)n=256*n+e[t],t++}}const o=t+n;return{byteLength:o,contents:e.subarray(t,o),raw:e.subarray(0,o)}}function Oe(e){const t=e.replace(/(?:-----(?:BEGIN|END) CERTIFICATE-----|\s)/g,""),r=m(t);return Se(function(e){const t=Ie(Ie(Re(e).contents)[0].contents);return w(t[160===t[0].raw[0]?6:5].raw)}(r),"PUBLIC KEY")}const Me=(e,t,r)=>{let n;try{n=Oe(e)}catch(e){throw new TypeError("Failed to parse the X.509 certificate",{cause:e})}return ke(n,t,r)};async function De(e,t,r){if("string"!=typeof e||0!==e.indexOf("-----BEGIN PUBLIC KEY-----"))throw new TypeError('"spki" must be SPKI formatted string');return ke(e,t,r)}async function Ke(e,t,r){if("string"!=typeof e||0!==e.indexOf("-----BEGIN CERTIFICATE-----"))throw new TypeError('"x509" must be X.509 formatted string');return Me(e,t,r)}async function We(e,t,r){if("string"!=typeof e||0!==e.indexOf("-----BEGIN PRIVATE KEY-----"))throw new TypeError('"pkcs8" must be PKCS#8 formatted string');return Pe(e,t,r)}async function Ne(e,t){if(!Z(e))throw new TypeError("JWK must be an object");switch(t||(t=e.alg),e.kty){case"oct":if("string"!=typeof e.k||!e.k)throw new TypeError('missing "k" (Key Value) Parameter value');return A(e.k);case"RSA":if(void 0!==e.oth)throw new T('RSA JWK "oth" (Other Primes Info) Parameter value is not supported');case"EC":case"OKP":return ue({...e,alg:t});default:throw new T('Unsupported "kty" (Key Type) Parameter value')}}const Je=e=>e?.[Symbol.toStringTag],xe=(e,t,r)=>{if(void 0!==t.use&&"sig"!==t.use)throw new TypeError("Invalid key for this operation, when present its use must be sig");if(void 0!==t.key_ops&&!0!==t.key_ops.includes?.(r))throw new TypeError(`Invalid key for this operation, when present its key_ops must include ${r}`);if(void 0!==t.alg&&t.alg!==e)throw new TypeError(`Invalid key for this operation, when present its alg must be ${e}`);return!0},Le=(e,t,r,n)=>{if(!(t instanceof Uint8Array)){if(n&&le(t)){if(function(e){return le(e)&&"oct"===e.kty&&"string"==typeof e.k}(t)&&xe(e,t,r))return;throw new TypeError('JSON Web Key for symmetric algorithms must have JWK "kty" (Key Type) equal to "oct" and the JWK "k" (Key Value) present')}if(!q(t))throw new TypeError(X(e,t,...Y,"Uint8Array",n?"JSON Web Key":null));if("secret"!==t.type)throw new TypeError(`${Je(t)} instances for symmetric algorithms must be of type "secret"`)}};function Ue(e,t,r,n){t.startsWith("HS")||"dir"===t||t.startsWith("PBES2")||/^A\d{3}(?:GCM)?KW$/.test(t)?Le(t,r,n,e):((e,t,r,n)=>{if(n&&le(t))switch(r){case"sign":if(function(e){return"oct"!==e.kty&&"string"==typeof e.d}(t)&&xe(e,t,r))return;throw new TypeError("JSON Web Key for this operation be a private JWK");case"verify":if(function(e){return"oct"!==e.kty&&void 0===e.d}(t)&&xe(e,t,r))return;throw new TypeError("JSON Web Key for this operation be a public JWK")}if(!q(t))throw new TypeError(X(e,t,...Y,n?"JSON Web Key":null));if("secret"===t.type)throw new TypeError(`${Je(t)} instances for asymmetric algorithms must not be of type "secret"`);if("sign"===r&&"public"===t.type)throw new TypeError(`${Je(t)} instances for asymmetric algorithm signing must be of type "private"`);if("decrypt"===r&&"public"===t.type)throw new TypeError(`${Je(t)} instances for asymmetric algorithm decryption must be of type "private"`);if(t.algorithm&&"verify"===r&&"private"===t.type)throw new TypeError(`${Je(t)} instances for asymmetric algorithm verifying must be of type "public"`);if(t.algorithm&&"encrypt"===r&&"private"===t.type)throw new TypeError(`${Je(t)} instances for asymmetric algorithm encryption must be of type "public"`)})(t,r,n,e)}const Ge=Ue.bind(void 0,!1),je=Ue.bind(void 0,!0);const Be=async(e,t,r,n,o)=>{if(!(a(r)||r instanceof Uint8Array))throw new TypeError(V(r,...Y,"Uint8Array"));switch(n?N(e,n):n=K(new Uint8Array(W(e)>>3)),e){case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return r instanceof Uint8Array&&J(r,parseInt(e.slice(-3),10)),async function(e,t,r,n,o){if(!(r instanceof Uint8Array))throw new TypeError(V(r,"Uint8Array"));const a=parseInt(e.slice(1,4),10),s=await i.subtle.importKey("raw",r.subarray(a>>3),"AES-CBC",!1,["encrypt"]),c=await i.subtle.importKey("raw",r.subarray(0,a>>3),{hash:"SHA-"+(a<<1),name:"HMAC"},!1,["sign"]),d=new Uint8Array(await i.subtle.encrypt({iv:n,name:"AES-CBC"},s,t)),l=u(o,n,d,p(o.length<<3));return{ciphertext:d,tag:new Uint8Array((await i.subtle.sign("HMAC",c,l)).slice(0,a>>3)),iv:n}}(e,t,r,n,o);case"A128GCM":case"A192GCM":case"A256GCM":return r instanceof Uint8Array&&J(r,parseInt(e.slice(1,4),10)),async function(e,t,r,n,o){let a;r instanceof Uint8Array?a=await i.subtle.importKey("raw",r,"AES-GCM",!1,["encrypt"]):($(r,e,"encrypt"),a=r);const s=new Uint8Array(await i.subtle.encrypt({additionalData:o,iv:n,name:"AES-GCM",tagLength:128},a,t)),c=s.slice(-16);return{ciphertext:s.slice(0,-16),tag:c,iv:n}}(e,t,r,n,o);default:throw new T("Unsupported JWE Content Encryption Algorithm")}};const $e=async function(e,t,r,n,o){switch(Ge(e,t,"decrypt"),t=await(me?.(t,e))||t,e){case"dir":if(void 0!==r)throw new C("Encountered unexpected JWE Encrypted Key");return t;case"ECDH-ES":if(void 0!==r)throw new C("Encountered unexpected JWE Encrypted Key");case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{if(!Z(n.epk))throw new C('JOSE Header "epk" (Ephemeral Public Key) missing or invalid');if(!ae(t))throw new T("ECDH with the provided key is not allowed or not supported by your javascript runtime");const o=await Ne(n.epk,e);let i,a;if(void 0!==n.apu){if("string"!=typeof n.apu)throw new C('JOSE Header "apu" (Agreement PartyUInfo) invalid');try{i=A(n.apu)}catch{throw new C("Failed to base64url decode the apu")}}if(void 0!==n.apv){if("string"!=typeof n.apv)throw new C('JOSE Header "apv" (Agreement PartyVInfo) invalid');try{a=A(n.apv)}catch{throw new C("Failed to base64url decode the apv")}}const s=await ie(o,t,"ECDH-ES"===e?n.enc:e,"ECDH-ES"===e?Ae(n.enc):parseInt(e.slice(-5,-2),10),i,a);if("ECDH-ES"===e)return s;if(void 0===r)throw new C("JWE Encrypted Key missing");return oe(e.slice(-6),s,r)}case"RSA1_5":case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":if(void 0===r)throw new C("JWE Encrypted Key missing");return(async(e,t,r)=>{if(!a(t))throw new TypeError(V(t,...Y));if($(t,e,"decrypt","unwrapKey"),de(e,t),t.usages.includes("decrypt"))return new Uint8Array(await i.subtle.decrypt(ce(e),t,r));if(t.usages.includes("unwrapKey")){const n=await i.subtle.unwrapKey("raw",r,t,ce(e),...ee);return new Uint8Array(await i.subtle.exportKey("raw",n))}throw new TypeError('RSA-OAEP key "usages" must include "decrypt" or "unwrapKey" for this operation')})(e,t,r);case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":{if(void 0===r)throw new C("JWE Encrypted Key missing");if("number"!=typeof n.p2c)throw new C('JOSE Header "p2c" (PBES2 Count) missing or invalid');const i=o?.maxPBES2Count||1e4;if(n.p2c>i)throw new C('JOSE Header "p2c" (PBES2 Count) out is of acceptable bounds');if("string"!=typeof n.p2s)throw new C('JOSE Header "p2s" (PBES2 Salt) missing or invalid');let a;try{a=A(n.p2s)}catch{throw new C("Failed to base64url decode the p2s")}return(async(e,t,r,n,o)=>{const i=await se(o,e,n,t);return oe(e.slice(-6),i,r)})(e,t,r,n.p2c,a)}case"A128KW":case"A192KW":case"A256KW":if(void 0===r)throw new C("JWE Encrypted Key missing");return oe(e,t,r);case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":{if(void 0===r)throw new C("JWE Encrypted Key missing");if("string"!=typeof n.iv)throw new C('JOSE Header "iv" (Initialization Vector) missing or invalid');if("string"!=typeof n.tag)throw new C('JOSE Header "tag" (Authentication Tag) missing or invalid');let o,i;try{o=A(n.iv)}catch{throw new C("Failed to base64url decode the iv")}try{i=A(n.tag)}catch{throw new C("Failed to base64url decode the tag")}return async function(e,t,r,n,o){const i=e.slice(0,7);return z(i,t,r,n,o,new Uint8Array(0))}(e,t,r,o,i)}default:throw new T('Invalid or unsupported "alg" (JWE Algorithm) header value')}};const Fe=function(e,t,r,n,o){if(void 0!==o.crit&&void 0===n?.crit)throw new e('"crit" (Critical) Header Parameter MUST be integrity protected');if(!n||void 0===n.crit)return new Set;if(!Array.isArray(n.crit)||0===n.crit.length||n.crit.some((e=>"string"!=typeof e||0===e.length)))throw new e('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');let i;i=void 0!==r?new Map([...Object.entries(r),...t.entries()]):t;for(const t of n.crit){if(!i.has(t))throw new T(`Extension Header Parameter "${t}" is not recognized`);if(void 0===o[t])throw new e(`Extension Header Parameter "${t}" is missing`);if(i.get(t)&&void 0===n[t])throw new e(`Extension Header Parameter "${t}" MUST be integrity protected`)}return new Set(n.crit)},Ve=(e,t)=>{if(void 0!==t&&(!Array.isArray(t)||t.some((e=>"string"!=typeof e))))throw new TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)};async function Xe(e,t,r){if(!Z(e))throw new C("Flattened JWE must be an object");if(void 0===e.protected&&void 0===e.header&&void 0===e.unprotected)throw new C("JOSE Header missing");if(void 0!==e.iv&&"string"!=typeof e.iv)throw new C("JWE Initialization Vector incorrect type");if("string"!=typeof e.ciphertext)throw new C("JWE Ciphertext missing or incorrect type");if(void 0!==e.tag&&"string"!=typeof e.tag)throw new C("JWE Authentication Tag incorrect type");if(void 0!==e.protected&&"string"!=typeof e.protected)throw new C("JWE Protected Header incorrect type");if(void 0!==e.encrypted_key&&"string"!=typeof e.encrypted_key)throw new C("JWE Encrypted Key incorrect type");if(void 0!==e.aad&&"string"!=typeof e.aad)throw new C("JWE AAD incorrect type");if(void 0!==e.header&&!Z(e.header))throw new C("JWE Shared Unprotected Header incorrect type");if(void 0!==e.unprotected&&!Z(e.unprotected))throw new C("JWE Per-Recipient Unprotected Header incorrect type");let n;if(e.protected)try{const t=A(e.protected);n=JSON.parse(d.decode(t))}catch{throw new C("JWE Protected Header is invalid")}if(!Q(n,e.header,e.unprotected))throw new C("JWE Protected, JWE Unprotected Header, and JWE Per-Recipient Unprotected Header Parameter names must be disjoint");const o={...n,...e.header,...e.unprotected};if(Fe(C,new Map,r?.crit,n,o),void 0!==o.zip)throw new T('JWE "zip" (Compression Algorithm) Header Parameter is not supported.');const{alg:i,enc:a}=o;if("string"!=typeof i||!i)throw new C("missing JWE Algorithm (alg) in JWE Header");if("string"!=typeof a||!a)throw new C("missing JWE Encryption Algorithm (enc) in JWE Header");const s=r&&Ve("keyManagementAlgorithms",r.keyManagementAlgorithms),l=r&&Ve("contentEncryptionAlgorithms",r.contentEncryptionAlgorithms);if(s&&!s.has(i)||!s&&i.startsWith("PBES2"))throw new _('"alg" (Algorithm) Header Parameter value not allowed');if(l&&!l.has(a))throw new _('"enc" (Encryption Algorithm) Header Parameter value not allowed');let h;if(void 0!==e.encrypted_key)try{h=A(e.encrypted_key)}catch{throw new C("Failed to base64url decode the encrypted_key")}let p,y,f,w=!1;"function"==typeof t&&(t=await t(n,e),w=!0);try{p=await $e(i,t,h,o,r)}catch(e){if(e instanceof TypeError||e instanceof C||e instanceof T)throw e;p=ge(a)}if(void 0!==e.iv)try{y=A(e.iv)}catch{throw new C("Failed to base64url decode the iv")}if(void 0!==e.tag)try{f=A(e.tag)}catch{throw new C("Failed to base64url decode the tag")}const E=c.encode(e.protected??"");let m,g;m=void 0!==e.aad?u(E,c.encode("."),c.encode(e.aad)):E;try{g=A(e.ciphertext)}catch{throw new C("Failed to base64url decode the ciphertext")}const S={plaintext:await z(a,p,g,y,f,m)};if(void 0!==e.protected&&(S.protectedHeader=n),void 0!==e.aad)try{S.additionalAuthenticatedData=A(e.aad)}catch{throw new C("Failed to base64url decode the aad")}return void 0!==e.unprotected&&(S.sharedUnprotectedHeader=e.unprotected),void 0!==e.header&&(S.unprotectedHeader=e.header),w?{...S,key:t}:S}async function qe(e,t,r){if(e instanceof Uint8Array&&(e=d.decode(e)),"string"!=typeof e)throw new C("Compact JWE must be a string or Uint8Array");const{0:n,1:o,2:i,3:a,4:s,length:c}=e.split(".");if(5!==c)throw new C("Invalid Compact JWE");const l=await Xe({ciphertext:a,iv:i||void 0,protected:n,tag:s||void 0,encrypted_key:o||void 0},t,r),u={plaintext:l.plaintext,protectedHeader:l.protectedHeader};return"function"==typeof t?{...u,key:l.key}:u}async function Ye(e,t,r){if(!Z(e))throw new C("General JWE must be an object");if(!Array.isArray(e.recipients)||!e.recipients.every(Z))throw new C("JWE Recipients missing or incorrect type");if(!e.recipients.length)throw new C("JWE Recipients has no members");for(const n of e.recipients)try{return await Xe({aad:e.aad,ciphertext:e.ciphertext,encrypted_key:n.encrypted_key,header:n.header,iv:e.iv,protected:e.protected,tag:e.tag,unprotected:e.unprotected},t,r)}catch{}throw new b}const ze=Symbol(),Qe=async e=>{if(e instanceof Uint8Array)return{kty:"oct",k:E(e)};if(!a(e))throw new TypeError(V(e,...Y,"Uint8Array"));if(!e.extractable)throw new TypeError("non-extractable CryptoKey cannot be exported as a JWK");const{ext:t,key_ops:r,alg:n,use:o,...s}=await i.subtle.exportKey("jwk",e);return s};async function Ze(e){return _e(e)}async function et(e){return Te(e)}async function tt(e){return Qe(e)}const rt=async function(e,t,r,n,o={}){let s,c,d;switch(Ge(e,r,"encrypt"),r=await(Ee?.(r,e))||r,e){case"dir":d=r;break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{if(!ae(r))throw new T("ECDH with the provided key is not allowed or not supported by your javascript runtime");const{apu:l,apv:u}=o;let{epk:h}=o;h||(h=(await async function(e){if(!a(e))throw new TypeError(V(e,...Y));return i.subtle.generateKey(e.algorithm,!0,["deriveBits"])}(r)).privateKey);const{x:p,y,crv:f,kty:w}=await tt(h),m=await ie(r,h,"ECDH-ES"===e?t:e,"ECDH-ES"===e?Ae(t):parseInt(e.slice(-5,-2),10),l,u);if(c={epk:{x:p,crv:f,kty:w}},"EC"===w&&(c.epk.y=y),l&&(c.apu=E(l)),u&&(c.apv=E(u)),"ECDH-ES"===e){d=m;break}d=n||ge(t);const A=e.slice(-6);s=await ne(A,m,d);break}case"RSA1_5":case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":d=n||ge(t),s=await(async(e,t,r)=>{if(!a(t))throw new TypeError(V(t,...Y));if($(t,e,"encrypt","wrapKey"),de(e,t),t.usages.includes("encrypt"))return new Uint8Array(await i.subtle.encrypt(ce(e),t,r));if(t.usages.includes("wrapKey")){const n=await i.subtle.importKey("raw",r,...ee);return new Uint8Array(await i.subtle.wrapKey("raw",n,t,ce(e)))}throw new TypeError('RSA-OAEP key "usages" must include "encrypt" or "wrapKey" for this operation')})(e,r,d);break;case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":{d=n||ge(t);const{p2c:i,p2s:a}=o;({encryptedKey:s,...c}=await(async(e,t,r,n=2048,o=K(new Uint8Array(16)))=>{const i=await se(o,e,n,t);return{encryptedKey:await ne(e.slice(-6),i,r),p2c:n,p2s:E(o)}})(e,r,d,i,a));break}case"A128KW":case"A192KW":case"A256KW":d=n||ge(t),s=await ne(e,r,d);break;case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":{d=n||ge(t);const{iv:i}=o;({encryptedKey:s,...c}=await async function(e,t,r,n){const o=e.slice(0,7),i=await Be(o,r,t,n,new Uint8Array(0));return{encryptedKey:i.ciphertext,iv:E(i.iv),tag:E(i.tag)}}(e,r,d,i));break}default:throw new T('Invalid or unsupported "alg" (JWE Algorithm) header value')}return{cek:d,encryptedKey:s,parameters:c}};class nt{constructor(e){if(!(e instanceof Uint8Array))throw new TypeError("plaintext must be an instance of Uint8Array");this._plaintext=e}setKeyManagementParameters(e){if(this._keyManagementParameters)throw new TypeError("setKeyManagementParameters can only be called once");return this._keyManagementParameters=e,this}setProtectedHeader(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setSharedUnprotectedHeader(e){if(this._sharedUnprotectedHeader)throw new TypeError("setSharedUnprotectedHeader can only be called once");return this._sharedUnprotectedHeader=e,this}setUnprotectedHeader(e){if(this._unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}setAdditionalAuthenticatedData(e){return this._aad=e,this}setContentEncryptionKey(e){if(this._cek)throw new TypeError("setContentEncryptionKey can only be called once");return this._cek=e,this}setInitializationVector(e){if(this._iv)throw new TypeError("setInitializationVector can only be called once");return this._iv=e,this}async encrypt(e,t){if(!this._protectedHeader&&!this._unprotectedHeader&&!this._sharedUnprotectedHeader)throw new C("either setProtectedHeader, setUnprotectedHeader, or sharedUnprotectedHeader must be called before #encrypt()");if(!Q(this._protectedHeader,this._unprotectedHeader,this._sharedUnprotectedHeader))throw new C("JWE Protected, JWE Shared Unprotected and JWE Per-Recipient Header Parameter names must be disjoint");const r={...this._protectedHeader,...this._unprotectedHeader,...this._sharedUnprotectedHeader};if(Fe(C,new Map,t?.crit,this._protectedHeader,r),void 0!==r.zip)throw new T('JWE "zip" (Compression Algorithm) Header Parameter is not supported.');const{alg:n,enc:o}=r;if("string"!=typeof n||!n)throw new C('JWE "alg" (Algorithm) Header Parameter missing or invalid');if("string"!=typeof o||!o)throw new C('JWE "enc" (Encryption Algorithm) Header Parameter missing or invalid');let i,a,s,l,h;if(this._cek&&("dir"===n||"ECDH-ES"===n))throw new TypeError(`setContentEncryptionKey cannot be called with JWE "alg" (Algorithm) Header ${n}`);{let r;({cek:a,encryptedKey:i,parameters:r}=await rt(n,o,e,this._cek,this._keyManagementParameters)),r&&(t&&ze in t?this._unprotectedHeader?this._unprotectedHeader={...this._unprotectedHeader,...r}:this.setUnprotectedHeader(r):this._protectedHeader?this._protectedHeader={...this._protectedHeader,...r}:this.setProtectedHeader(r))}l=this._protectedHeader?c.encode(E(JSON.stringify(this._protectedHeader))):c.encode(""),this._aad?(h=E(this._aad),s=u(l,c.encode("."),c.encode(h))):s=l;const{ciphertext:p,tag:y,iv:f}=await Be(o,this._plaintext,a,this._iv,s),w={ciphertext:E(p)};return f&&(w.iv=E(f)),y&&(w.tag=E(y)),i&&(w.encrypted_key=E(i)),h&&(w.aad=h),this._protectedHeader&&(w.protected=d.decode(l)),this._sharedUnprotectedHeader&&(w.unprotected=this._sharedUnprotectedHeader),this._unprotectedHeader&&(w.header=this._unprotectedHeader),w}}class ot{constructor(e,t,r){this.parent=e,this.key=t,this.options=r}setUnprotectedHeader(e){if(this.unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this.unprotectedHeader=e,this}addRecipient(...e){return this.parent.addRecipient(...e)}encrypt(...e){return this.parent.encrypt(...e)}done(){return this.parent}}class it{constructor(e){this._recipients=[],this._plaintext=e}addRecipient(e,t){const r=new ot(this,e,{crit:t?.crit});return this._recipients.push(r),r}setProtectedHeader(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setSharedUnprotectedHeader(e){if(this._unprotectedHeader)throw new TypeError("setSharedUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}setAdditionalAuthenticatedData(e){return this._aad=e,this}async encrypt(){if(!this._recipients.length)throw new C("at least one recipient must be added");if(1===this._recipients.length){const[e]=this._recipients,t=await new nt(this._plaintext).setAdditionalAuthenticatedData(this._aad).setProtectedHeader(this._protectedHeader).setSharedUnprotectedHeader(this._unprotectedHeader).setUnprotectedHeader(e.unprotectedHeader).encrypt(e.key,{...e.options}),r={ciphertext:t.ciphertext,iv:t.iv,recipients:[{}],tag:t.tag};return t.aad&&(r.aad=t.aad),t.protected&&(r.protected=t.protected),t.unprotected&&(r.unprotected=t.unprotected),t.encrypted_key&&(r.recipients[0].encrypted_key=t.encrypted_key),t.header&&(r.recipients[0].header=t.header),r}let e;for(let t=0;t<this._recipients.length;t++){const r=this._recipients[t];if(!Q(this._protectedHeader,this._unprotectedHeader,r.unprotectedHeader))throw new C("JWE Protected, JWE Shared Unprotected and JWE Per-Recipient Header Parameter names must be disjoint");const n={...this._protectedHeader,...this._unprotectedHeader,...r.unprotectedHeader},{alg:o}=n;if("string"!=typeof o||!o)throw new C('JWE "alg" (Algorithm) Header Parameter missing or invalid');if("dir"===o||"ECDH-ES"===o)throw new C('"dir" and "ECDH-ES" alg may only be used with a single recipient');if("string"!=typeof n.enc||!n.enc)throw new C('JWE "enc" (Encryption Algorithm) Header Parameter missing or invalid');if(e){if(e!==n.enc)throw new C('JWE "enc" (Encryption Algorithm) Header Parameter must be the same for all recipients')}else e=n.enc;if(Fe(C,new Map,r.options.crit,this._protectedHeader,n),void 0!==n.zip)throw new T('JWE "zip" (Compression Algorithm) Header Parameter is not supported.')}const t=ge(e),r={ciphertext:"",iv:"",recipients:[],tag:""};for(let n=0;n<this._recipients.length;n++){const o=this._recipients[n],i={};r.recipients.push(i);const a={...this._protectedHeader,...this._unprotectedHeader,...o.unprotectedHeader}.alg.startsWith("PBES2")?2048+n:void 0;if(0===n){const e=await new nt(this._plaintext).setAdditionalAuthenticatedData(this._aad).setContentEncryptionKey(t).setProtectedHeader(this._protectedHeader).setSharedUnprotectedHeader(this._unprotectedHeader).setUnprotectedHeader(o.unprotectedHeader).setKeyManagementParameters({p2c:a}).encrypt(o.key,{...o.options,[ze]:!0});r.ciphertext=e.ciphertext,r.iv=e.iv,r.tag=e.tag,e.aad&&(r.aad=e.aad),e.protected&&(r.protected=e.protected),e.unprotected&&(r.unprotected=e.unprotected),i.encrypted_key=e.encrypted_key,e.header&&(i.header=e.header);continue}const{encryptedKey:s,parameters:c}=await rt(o.unprotectedHeader?.alg||this._protectedHeader?.alg||this._unprotectedHeader?.alg,e,o.key,t,{p2c:a});i.encrypted_key=E(s),(o.unprotectedHeader||c)&&(i.header={...o.unprotectedHeader,...c})}return r}}function at(e,t){const r=`SHA-${e.slice(-3)}`;switch(e){case"HS256":case"HS384":case"HS512":return{hash:r,name:"HMAC"};case"PS256":case"PS384":case"PS512":return{hash:r,name:"RSA-PSS",saltLength:e.slice(-3)>>3};case"RS256":case"RS384":case"RS512":return{hash:r,name:"RSASSA-PKCS1-v1_5"};case"ES256":case"ES384":case"ES512":return{hash:r,name:"ECDSA",namedCurve:t.namedCurve};case"EdDSA":return{name:t.name};default:throw new T(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}async function st(e,t,r){if("sign"===r&&(t=await me(t,e)),"verify"===r&&(t=await Ee(t,e)),a(t))return B(t,e,r),t;if(t instanceof Uint8Array){if(!e.startsWith("HS"))throw new TypeError(V(t,...Y));return i.subtle.importKey("raw",t,{hash:`SHA-${e.slice(-3)}`,name:"HMAC"},!1,[r])}throw new TypeError(V(t,...Y,"Uint8Array","JSON Web Key"))}const ct=async(e,t,r,n)=>{const o=await st(e,t,"verify");de(e,o);const a=at(e,o.algorithm);try{return await i.subtle.verify(a,o,r,n)}catch{return!1}};async function dt(e,t,r){if(!Z(e))throw new H("Flattened JWS must be an object");if(void 0===e.protected&&void 0===e.header)throw new H('Flattened JWS must have either of the "protected" or "header" members');if(void 0!==e.protected&&"string"!=typeof e.protected)throw new H("JWS Protected Header incorrect type");if(void 0===e.payload)throw new H("JWS Payload missing");if("string"!=typeof e.signature)throw new H("JWS Signature missing or incorrect type");if(void 0!==e.header&&!Z(e.header))throw new H("JWS Unprotected Header incorrect type");let n={};if(e.protected)try{const t=A(e.protected);n=JSON.parse(d.decode(t))}catch{throw new H("JWS Protected Header is invalid")}if(!Q(n,e.header))throw new H("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const o={...n,...e.header};let i=!0;if(Fe(H,new Map([["b64",!0]]),r?.crit,n,o).has("b64")&&(i=n.b64,"boolean"!=typeof i))throw new H('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:a}=o;if("string"!=typeof a||!a)throw new H('JWS "alg" (Algorithm) Header Parameter missing or invalid');const s=r&&Ve("algorithms",r.algorithms);if(s&&!s.has(a))throw new _('"alg" (Algorithm) Header Parameter value not allowed');if(i){if("string"!=typeof e.payload)throw new H("JWS Payload must be a string")}else if("string"!=typeof e.payload&&!(e.payload instanceof Uint8Array))throw new H("JWS Payload must be a string or an Uint8Array instance");let l=!1;"function"==typeof t?(t=await t(n,e),l=!0,je(a,t,"verify"),le(t)&&(t=await Ne(t,a))):je(a,t,"verify");const h=u(c.encode(e.protected??""),c.encode("."),"string"==typeof e.payload?c.encode(e.payload):e.payload);let p;try{p=A(e.signature)}catch{throw new H("Failed to base64url decode the signature")}if(!await ct(a,t,p,h))throw new D;let y;if(i)try{y=A(e.payload)}catch{throw new H("Failed to base64url decode the payload")}else y="string"==typeof e.payload?c.encode(e.payload):e.payload;const f={payload:y};return void 0!==e.protected&&(f.protectedHeader=n),void 0!==e.header&&(f.unprotectedHeader=e.header),l?{...f,key:t}:f}async function lt(e,t,r){if(e instanceof Uint8Array&&(e=d.decode(e)),"string"!=typeof e)throw new H("Compact JWS must be a string or Uint8Array");const{0:n,1:o,2:i,length:a}=e.split(".");if(3!==a)throw new H("Invalid Compact JWS");const s=await dt({payload:o,protected:n,signature:i},t,r),c={payload:s.payload,protectedHeader:s.protectedHeader};return"function"==typeof t?{...c,key:s.key}:c}async function ut(e,t,r){if(!Z(e))throw new H("General JWS must be an object");if(!Array.isArray(e.signatures)||!e.signatures.every(Z))throw new H("JWS Signatures missing or incorrect type");for(const n of e.signatures)try{return await dt({header:n.header,payload:e.payload,protected:n.protected,signature:n.signature},t,r)}catch{}throw new D}const ht=e=>Math.floor(e.getTime()/1e3),pt=86400,yt=/^(\+|\-)? ?(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)(?: (ago|from now))?$/i,ft=e=>{const t=yt.exec(e);if(!t||t[4]&&t[1])throw new TypeError("Invalid time period format");const r=parseFloat(t[2]);let n;switch(t[3].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":n=Math.round(r);break;case"minute":case"minutes":case"min":case"mins":case"m":n=Math.round(60*r);break;case"hour":case"hours":case"hr":case"hrs":case"h":n=Math.round(3600*r);break;case"day":case"days":case"d":n=Math.round(r*pt);break;case"week":case"weeks":case"w":n=Math.round(604800*r);break;default:n=Math.round(31557600*r)}return"-"===t[1]||"ago"===t[4]?-n:n},wt=e=>e.toLowerCase().replace(/^application\//,""),Et=(e,t,r={})=>{let n;try{n=JSON.parse(d.decode(t))}catch{}if(!Z(n))throw new P("JWT Claims Set must be a top-level JSON object");const{typ:o}=r;if(o&&("string"!=typeof e.typ||wt(e.typ)!==wt(o)))throw new S('unexpected "typ" JWT header value',n,"typ","check_failed");const{requiredClaims:i=[],issuer:a,subject:s,audience:c,maxTokenAge:l}=r,u=[...i];void 0!==l&&u.push("iat"),void 0!==c&&u.push("aud"),void 0!==s&&u.push("sub"),void 0!==a&&u.push("iss");for(const e of new Set(u.reverse()))if(!(e in n))throw new S(`missing required "${e}" claim`,n,e,"missing");if(a&&!(Array.isArray(a)?a:[a]).includes(n.iss))throw new S('unexpected "iss" claim value',n,"iss","check_failed");if(s&&n.sub!==s)throw new S('unexpected "sub" claim value',n,"sub","check_failed");if(c&&(h=n.aud,p="string"==typeof c?[c]:c,!("string"==typeof h?p.includes(h):Array.isArray(h)&&p.some(Set.prototype.has.bind(new Set(h))))))throw new S('unexpected "aud" claim value',n,"aud","check_failed");var h,p;let y;switch(typeof r.clockTolerance){case"string":y=ft(r.clockTolerance);break;case"number":y=r.clockTolerance;break;case"undefined":y=0;break;default:throw new TypeError("Invalid clockTolerance option type")}const{currentDate:f}=r,w=ht(f||new Date);if((void 0!==n.iat||l)&&"number"!=typeof n.iat)throw new S('"iat" claim must be a number',n,"iat","invalid");if(void 0!==n.nbf){if("number"!=typeof n.nbf)throw new S('"nbf" claim must be a number',n,"nbf","invalid");if(n.nbf>w+y)throw new S('"nbf" claim timestamp check failed',n,"nbf","check_failed")}if(void 0!==n.exp){if("number"!=typeof n.exp)throw new S('"exp" claim must be a number',n,"exp","invalid");if(n.exp<=w-y)throw new v('"exp" claim timestamp check failed',n,"exp","check_failed")}if(l){const e=w-n.iat;if(e-y>("number"==typeof l?l:ft(l)))throw new v('"iat" claim timestamp check failed (too far in the past)',n,"iat","check_failed");if(e<0-y)throw new S('"iat" claim timestamp check failed (it should be in the past)',n,"iat","check_failed")}return n};async function mt(e,t,r){const n=await lt(e,t,r);if(n.protectedHeader.crit?.includes("b64")&&!1===n.protectedHeader.b64)throw new P("JWTs MUST NOT use unencoded payload");const o={payload:Et(n.protectedHeader,n.payload,r),protectedHeader:n.protectedHeader};return"function"==typeof t?{...o,key:n.key}:o}async function At(e,t,r){const n=await qe(e,t,r),o=Et(n.protectedHeader,n.plaintext,r),{protectedHeader:i}=n;if(void 0!==i.iss&&i.iss!==o.iss)throw new S('replicated "iss" claim header parameter mismatch',o,"iss","mismatch");if(void 0!==i.sub&&i.sub!==o.sub)throw new S('replicated "sub" claim header parameter mismatch',o,"sub","mismatch");if(void 0!==i.aud&&JSON.stringify(i.aud)!==JSON.stringify(o.aud))throw new S('replicated "aud" claim header parameter mismatch',o,"aud","mismatch");const a={payload:o,protectedHeader:i};return"function"==typeof t?{...a,key:n.key}:a}class gt{constructor(e){this._flattened=new nt(e)}setContentEncryptionKey(e){return this._flattened.setContentEncryptionKey(e),this}setInitializationVector(e){return this._flattened.setInitializationVector(e),this}setProtectedHeader(e){return this._flattened.setProtectedHeader(e),this}setKeyManagementParameters(e){return this._flattened.setKeyManagementParameters(e),this}async encrypt(e,t){const r=await this._flattened.encrypt(e,t);return[r.protected,r.encrypted_key,r.iv,r.ciphertext,r.tag].join(".")}}const St=async(e,t,r)=>{const n=await st(e,t,"sign");de(e,n);const o=await i.subtle.sign(at(e,n.algorithm),n,r);return new Uint8Array(o)};class vt{constructor(e){if(!(e instanceof Uint8Array))throw new TypeError("payload must be an instance of Uint8Array");this._payload=e}setProtectedHeader(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setUnprotectedHeader(e){if(this._unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}async sign(e,t){if(!this._protectedHeader&&!this._unprotectedHeader)throw new H("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!Q(this._protectedHeader,this._unprotectedHeader))throw new H("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const r={...this._protectedHeader,...this._unprotectedHeader};let n=!0;if(Fe(H,new Map([["b64",!0]]),t?.crit,this._protectedHeader,r).has("b64")&&(n=this._protectedHeader.b64,"boolean"!=typeof n))throw new H('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:o}=r;if("string"!=typeof o||!o)throw new H('JWS "alg" (Algorithm) Header Parameter missing or invalid');je(o,e,"sign");let i,a=this._payload;n&&(a=c.encode(E(a))),i=this._protectedHeader?c.encode(E(JSON.stringify(this._protectedHeader))):c.encode("");const s=u(i,c.encode("."),a),l=await St(o,e,s),h={signature:E(l),payload:""};return n&&(h.payload=d.decode(a)),this._unprotectedHeader&&(h.header=this._unprotectedHeader),this._protectedHeader&&(h.protected=d.decode(i)),h}}class _t{constructor(e){this._flattened=new vt(e)}setProtectedHeader(e){return this._flattened.setProtectedHeader(e),this}async sign(e,t){const r=await this._flattened.sign(e,t);if(void 0===r.payload)throw new TypeError("use the flattened module for creating JWS with b64: false");return`${r.protected}.${r.payload}.${r.signature}`}}class Tt{constructor(e,t,r){this.parent=e,this.key=t,this.options=r}setProtectedHeader(e){if(this.protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this.protectedHeader=e,this}setUnprotectedHeader(e){if(this.unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this.unprotectedHeader=e,this}addSignature(...e){return this.parent.addSignature(...e)}sign(...e){return this.parent.sign(...e)}done(){return this.parent}}class bt{constructor(e){this._signatures=[],this._payload=e}addSignature(e,t){const r=new Tt(this,e,t);return this._signatures.push(r),r}async sign(){if(!this._signatures.length)throw new H("at least one signature must be added");const e={signatures:[],payload:""};for(let t=0;t<this._signatures.length;t++){const r=this._signatures[t],n=new vt(this._payload);n.setProtectedHeader(r.protectedHeader),n.setUnprotectedHeader(r.unprotectedHeader);const{payload:o,...i}=await n.sign(r.key,r.options);if(0===t)e.payload=o;else if(e.payload!==o)throw new H("inconsistent use of JWS Unencoded Payload (RFC7797)");e.signatures.push(i)}return e}}function Ct(e,t){if(!Number.isFinite(t))throw new TypeError(`Invalid ${e} input`);return t}class Ht{constructor(e={}){if(!Z(e))throw new TypeError("JWT Claims Set MUST be an object");this._payload=e}setIssuer(e){return this._payload={...this._payload,iss:e},this}setSubject(e){return this._payload={...this._payload,sub:e},this}setAudience(e){return this._payload={...this._payload,aud:e},this}setJti(e){return this._payload={...this._payload,jti:e},this}setNotBefore(e){return"number"==typeof e?this._payload={...this._payload,nbf:Ct("setNotBefore",e)}:e instanceof Date?this._payload={...this._payload,nbf:Ct("setNotBefore",ht(e))}:this._payload={...this._payload,nbf:ht(new Date)+ft(e)},this}setExpirationTime(e){return"number"==typeof e?this._payload={...this._payload,exp:Ct("setExpirationTime",e)}:e instanceof Date?this._payload={...this._payload,exp:Ct("setExpirationTime",ht(e))}:this._payload={...this._payload,exp:ht(new Date)+ft(e)},this}setIssuedAt(e){return void 0===e?this._payload={...this._payload,iat:ht(new Date)}:e instanceof Date?this._payload={...this._payload,iat:Ct("setIssuedAt",ht(e))}:this._payload="string"==typeof e?{...this._payload,iat:Ct("setIssuedAt",ht(new Date)+ft(e))}:{...this._payload,iat:Ct("setIssuedAt",e)},this}}class Pt extends Ht{setProtectedHeader(e){return this._protectedHeader=e,this}async sign(e,t){const r=new _t(c.encode(JSON.stringify(this._payload)));if(r.setProtectedHeader(this._protectedHeader),Array.isArray(this._protectedHeader?.crit)&&this._protectedHeader.crit.includes("b64")&&!1===this._protectedHeader.b64)throw new P("JWTs MUST NOT use unencoded payload");return r.sign(e,t)}}class kt extends Ht{setProtectedHeader(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setKeyManagementParameters(e){if(this._keyManagementParameters)throw new TypeError("setKeyManagementParameters can only be called once");return this._keyManagementParameters=e,this}setContentEncryptionKey(e){if(this._cek)throw new TypeError("setContentEncryptionKey can only be called once");return this._cek=e,this}setInitializationVector(e){if(this._iv)throw new TypeError("setInitializationVector can only be called once");return this._iv=e,this}replicateIssuerAsHeader(){return this._replicateIssuerAsHeader=!0,this}replicateSubjectAsHeader(){return this._replicateSubjectAsHeader=!0,this}replicateAudienceAsHeader(){return this._replicateAudienceAsHeader=!0,this}async encrypt(e,t){const r=new gt(c.encode(JSON.stringify(this._payload)));return this._replicateIssuerAsHeader&&(this._protectedHeader={...this._protectedHeader,iss:this._payload.iss}),this._replicateSubjectAsHeader&&(this._protectedHeader={...this._protectedHeader,sub:this._payload.sub}),this._replicateAudienceAsHeader&&(this._protectedHeader={...this._protectedHeader,aud:this._payload.aud}),r.setProtectedHeader(this._protectedHeader),this._iv&&r.setInitializationVector(this._iv),this._cek&&r.setContentEncryptionKey(this._cek),this._keyManagementParameters&&r.setKeyManagementParameters(this._keyManagementParameters),r.encrypt(e,t)}}const It=(e,t)=>{if("string"!=typeof e||!e)throw new k(`${t} missing or invalid`)};async function Rt(e,t){if(!Z(e))throw new TypeError("JWK must be an object");if(t??(t="sha256"),"sha256"!==t&&"sha384"!==t&&"sha512"!==t)throw new TypeError('digestAlgorithm must one of "sha256", "sha384", or "sha512"');let r;switch(e.kty){case"EC":It(e.crv,'"crv" (Curve) Parameter'),It(e.x,'"x" (X Coordinate) Parameter'),It(e.y,'"y" (Y Coordinate) Parameter'),r={crv:e.crv,kty:e.kty,x:e.x,y:e.y};break;case"OKP":It(e.crv,'"crv" (Subtype of Key Pair) Parameter'),It(e.x,'"x" (Public Key) Parameter'),r={crv:e.crv,kty:e.kty,x:e.x};break;case"RSA":It(e.e,'"e" (Exponent) Parameter'),It(e.n,'"n" (Modulus) Parameter'),r={e:e.e,kty:e.kty,n:e.n};break;case"oct":It(e.k,'"k" (Key Value) Parameter'),r={k:e.k,kty:e.kty};break;default:throw new T('"kty" (Key Type) Parameter missing or unsupported')}const n=c.encode(JSON.stringify(r));return E(await s(t,n))}async function Ot(e,t){t??(t="sha256");const r=await Rt(e,t);return`urn:ietf:params:oauth:jwk-thumbprint:sha-${t.slice(-3)}:${r}`}async function Mt(e,t){const r={...e,...t?.header};if(!Z(r.jwk))throw new H('"jwk" (JSON Web Key) Header Parameter must be a JSON object');const n=await Ne({...r.jwk,ext:!0},r.alg);if(n instanceof Uint8Array||"public"!==n.type)throw new H('"jwk" (JSON Web Key) Header Parameter must be a public key');return n}function Dt(e){return Z(e)}function Kt(e){return"function"==typeof structuredClone?structuredClone(e):JSON.parse(JSON.stringify(e))}class Wt{constructor(e){if(this._cached=new WeakMap,!function(e){return e&&"object"==typeof e&&Array.isArray(e.keys)&&e.keys.every(Dt)}(e))throw new I("JSON Web Key Set malformed");this._jwks=Kt(e)}async getKey(e,t){const{alg:r,kid:n}={...e,...t?.header},o=function(e){switch("string"==typeof e&&e.slice(0,2)){case"RS":case"PS":return"RSA";case"ES":return"EC";case"Ed":return"OKP";default:throw new T('Unsupported "alg" value for a JSON Web Key Set')}}(r),i=this._jwks.keys.filter((e=>{let t=o===e.kty;if(t&&"string"==typeof n&&(t=n===e.kid),t&&"string"==typeof e.alg&&(t=r===e.alg),t&&"string"==typeof e.use&&(t="sig"===e.use),t&&Array.isArray(e.key_ops)&&(t=e.key_ops.includes("verify")),t&&"EdDSA"===r&&(t="Ed25519"===e.crv||"Ed448"===e.crv),t)switch(r){case"ES256":t="P-256"===e.crv;break;case"ES256K":t="secp256k1"===e.crv;break;case"ES384":t="P-384"===e.crv;break;case"ES512":t="P-521"===e.crv}return t})),{0:a,length:s}=i;if(0===s)throw new R;if(1!==s){const e=new O,{_cached:t}=this;throw e[Symbol.asyncIterator]=async function*(){for(const e of i)try{yield await Nt(t,e,r)}catch{}},e}return Nt(this._cached,a,r)}}async function Nt(e,t,r){const n=e.get(t)||e.set(t,{}).get(t);if(void 0===n[r]){const e=await Ne({...t,ext:!0},r);if(e instanceof Uint8Array||"public"!==e.type)throw new I("JSON Web Key Set members must be public keys");n[r]=e}return n[r]}function Jt(e){const t=new Wt(e),r=async(e,r)=>t.getKey(e,r);return Object.defineProperties(r,{jwks:{value:()=>Kt(t._jwks),enumerable:!0,configurable:!1,writable:!1}}),r}const xt=async(e,t,r)=>{let n,o,i=!1;"function"==typeof AbortController&&(n=new AbortController,o=setTimeout((()=>{i=!0,n.abort()}),t));const a=await fetch(e.href,{signal:n?n.signal:void 0,redirect:"manual",headers:r.headers}).catch((e=>{if(i)throw new M;throw e}));if(void 0!==o&&clearTimeout(o),200!==a.status)throw new g("Expected 200 OK from the JSON Web Key Set HTTP response");try{return await a.json()}catch{throw new g("Failed to parse the JSON Web Key Set HTTP response as JSON")}};let Lt;if("undefined"==typeof navigator||!navigator.userAgent?.startsWith?.("Mozilla/5.0 ")){Lt=`${"jose"}/${"v5.9.6"}`}const Ut=Symbol();class Gt{constructor(e,t){if(!(e instanceof URL))throw new TypeError("url must be an instance of URL");var r,n;this._url=new URL(e.href),this._options={agent:t?.agent,headers:t?.headers},this._timeoutDuration="number"==typeof t?.timeoutDuration?t?.timeoutDuration:5e3,this._cooldownDuration="number"==typeof t?.cooldownDuration?t?.cooldownDuration:3e4,this._cacheMaxAge="number"==typeof t?.cacheMaxAge?t?.cacheMaxAge:6e5,void 0!==t?.[Ut]&&(this._cache=t?.[Ut],r=t?.[Ut],n=this._cacheMaxAge,"object"==typeof r&&null!==r&&"uat"in r&&"number"==typeof r.uat&&!(Date.now()-r.uat>=n)&&"jwks"in r&&Z(r.jwks)&&Array.isArray(r.jwks.keys)&&Array.prototype.every.call(r.jwks.keys,Z)&&(this._jwksTimestamp=this._cache.uat,this._local=Jt(this._cache.jwks)))}coolingDown(){return"number"==typeof this._jwksTimestamp&&Date.now()<this._jwksTimestamp+this._cooldownDuration}fresh(){return"number"==typeof this._jwksTimestamp&&Date.now()<this._jwksTimestamp+this._cacheMaxAge}async getKey(e,t){this._local&&this.fresh()||await this.reload();try{return await this._local(e,t)}catch(r){if(r instanceof R&&!1===this.coolingDown())return await this.reload(),this._local(e,t);throw r}}async reload(){this._pendingFetch&&("undefined"!=typeof WebSocketPair||"undefined"!=typeof navigator&&"Cloudflare-Workers"===navigator.userAgent||"undefined"!=typeof EdgeRuntime&&"vercel"===EdgeRuntime)&&(this._pendingFetch=void 0);const e=new Headers(this._options.headers);Lt&&!e.has("User-Agent")&&(e.set("User-Agent",Lt),this._options.headers=Object.fromEntries(e.entries())),this._pendingFetch||(this._pendingFetch=xt(this._url,this._timeoutDuration,this._options).then((e=>{this._local=Jt(e),this._cache&&(this._cache.uat=Date.now(),this._cache.jwks=e),this._jwksTimestamp=Date.now(),this._pendingFetch=void 0})).catch((e=>{throw this._pendingFetch=void 0,e}))),await this._pendingFetch}}function jt(e,t){const r=new Gt(e,t),n=async(e,t)=>r.getKey(e,t);return Object.defineProperties(n,{coolingDown:{get:()=>r.coolingDown(),enumerable:!0,configurable:!1},fresh:{get:()=>r.fresh(),enumerable:!0,configurable:!1},reload:{value:()=>r.reload(),enumerable:!0,configurable:!1,writable:!1},reloading:{get:()=>!!r._pendingFetch,enumerable:!0,configurable:!1},jwks:{value:()=>r._local?.jwks(),enumerable:!0,configurable:!1,writable:!1}}),n}const Bt=Ut;class $t extends Ht{encode(){return`${E(JSON.stringify({alg:"none"}))}.${E(JSON.stringify(this._payload))}.`}static decode(e,t){if("string"!=typeof e)throw new P("Unsecured JWT must be a string");const{0:r,1:n,2:o,length:i}=e.split(".");if(3!==i||""!==o)throw new P("Invalid Unsecured JWT");let a;try{if(a=JSON.parse(d.decode(A(r))),"none"!==a.alg)throw new Error}catch{throw new P("Invalid Unsecured JWT")}return{payload:Et(a,A(n),t),header:a}}}const Ft=E,Vt=A;function Xt(e){let t;if("string"==typeof e){const r=e.split(".");3!==r.length&&5!==r.length||([t]=r)}else if("object"==typeof e&&e){if(!("protected"in e))throw new TypeError("Token does not contain a Protected Header");t=e.protected}try{if("string"!=typeof t||!t)throw new Error;const e=JSON.parse(d.decode(Vt(t)));if(!Z(e))throw new Error;return e}catch{throw new TypeError("Invalid Token or Protected Header formatting")}}function qt(e){if("string"!=typeof e)throw new P("JWTs must use Compact JWS serialization, JWT must be a string");const{1:t,length:r}=e.split(".");if(5===r)throw new P("Only JWTs using Compact JWS serialization can be decoded");if(3!==r)throw new P("Invalid JWT");if(!t)throw new P("JWTs must contain a payload");let n,o;try{n=Vt(t)}catch{throw new P("Failed to base64url decode the payload")}try{o=JSON.parse(d.decode(n))}catch{throw new P("Failed to parse the decoded payload as JSON")}if(!Z(o))throw new P("Invalid JWT Claims Set");return o}function Yt(e){const t=e?.modulusLength??2048;if("number"!=typeof t||t<2048)throw new T("Invalid or unsupported modulusLength option provided, 2048 bits or larger keys must be used");return t}async function zt(e,t){return async function(e,t){let r,n;switch(e){case"PS256":case"PS384":case"PS512":r={name:"RSA-PSS",hash:`SHA-${e.slice(-3)}`,publicExponent:new Uint8Array([1,0,1]),modulusLength:Yt(t)},n=["sign","verify"];break;case"RS256":case"RS384":case"RS512":r={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.slice(-3)}`,publicExponent:new Uint8Array([1,0,1]),modulusLength:Yt(t)},n=["sign","verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":r={name:"RSA-OAEP",hash:`SHA-${parseInt(e.slice(-3),10)||1}`,publicExponent:new Uint8Array([1,0,1]),modulusLength:Yt(t)},n=["decrypt","unwrapKey","encrypt","wrapKey"];break;case"ES256":r={name:"ECDSA",namedCurve:"P-256"},n=["sign","verify"];break;case"ES384":r={name:"ECDSA",namedCurve:"P-384"},n=["sign","verify"];break;case"ES512":r={name:"ECDSA",namedCurve:"P-521"},n=["sign","verify"];break;case"EdDSA":{n=["sign","verify"];const e=t?.crv??"Ed25519";switch(e){case"Ed25519":case"Ed448":r={name:e};break;default:throw new T("Invalid or unsupported crv option provided")}break}case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{n=["deriveKey","deriveBits"];const e=t?.crv??"P-256";switch(e){case"P-256":case"P-384":case"P-521":r={name:"ECDH",namedCurve:e};break;case"X25519":case"X448":r={name:e};break;default:throw new T("Invalid or unsupported crv option provided, supported values are P-256, P-384, P-521, X25519, and X448")}break}default:throw new T('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}return i.subtle.generateKey(r,t?.extractable??!1,n)}(e,t)}async function Qt(e,t){return async function(e,t){let r,n,o;switch(e){case"HS256":case"HS384":case"HS512":r=parseInt(e.slice(-3),10),n={name:"HMAC",hash:`SHA-${r}`,length:r},o=["sign","verify"];break;case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return r=parseInt(e.slice(-3),10),K(new Uint8Array(r>>3));case"A128KW":case"A192KW":case"A256KW":r=parseInt(e.slice(1,4),10),n={name:"AES-KW",length:r},o=["wrapKey","unwrapKey"];break;case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":case"A128GCM":case"A192GCM":case"A256GCM":r=parseInt(e.slice(1,4),10),n={name:"AES-GCM",length:r},o=["encrypt","decrypt"];break;default:throw new T('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}return i.subtle.generateKey(n,t?.extractable??!1,o)}(e,t)}const Zt="WebCryptoAPI"}},t={};function r(n){var o=t[n];if(void 0!==o)return o.exports;var i=t[n]={exports:{}};return e[n].call(i.exports,i,i.exports,r),i.exports}r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};r(8617)})();